<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0">
  <title>–°–µ–º–µ–π ¬∑ –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
  <!-- Leaflet (–∫–∞—Ä—Ç–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-database-compat.min.js"></script>
  <style>
    /* ===== –°–¢–ò–õ–ò ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: #f5faff; color: #003f5c; display: flex; flex-direction: column; min-height: 100vh; }
    .container { max-width: 1320px; margin: 0 auto; padding: 0 24px; }
    :root { --egov-blue: #004a7c; --egov-gold: #f5c542; --egov-radius: 24px; --egov-shadow: 0 10px 25px -5px rgba(0,53,84,0.1); }
    .navbar { background: white; box-shadow: 0 6px 24px rgba(0,74,124,0.06); padding: 12px 0; border-bottom: 4px solid var(--egov-gold); position: sticky; top: 0; z-index: 100; }
    .navbar-inner { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 800; color: var(--egov-blue); }
    .logo i { color: var(--egov-gold); }
    .nav-and-user { display: flex; align-items: center; gap: 30px; flex-wrap: wrap; }
    .main-nav { display: flex; list-style: none; gap: 28px; font-weight: 600; flex-wrap: wrap; }
    .main-nav li a { color: #004a7c; padding: 8px 0; border-bottom: 3px solid transparent; text-decoration: none; transition: 0.2s; }
    .main-nav li a:hover, .main-nav li a.active { border-bottom-color: var(--egov-gold); color: #002d42; }
    .user-section { display: flex; align-items: center; gap: 15px; }
    .btn { padding: 10px 22px; border-radius: 40px; border: none; font-weight: 600; background: var(--egov-blue); color: white; cursor: pointer; transition: 0.2s; box-shadow: 0 6px 14px rgba(0,74,124,0.15); }
    .btn:hover { background: #002e4a; transform: translateY(-2px); }
    .btn-outline { background: transparent; border: 2px solid var(--egov-blue); color: var(--egov-blue); box-shadow: none; }
    .btn-outline:hover { background: var(--egov-blue); color: white; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .lang-switcher { display: flex; gap: 8px; align-items: center; background: #eef6ff; padding: 5px 10px; border-radius: 30px; }
    .lang-btn { background: transparent; border: none; padding: 4px 10px; border-radius: 20px; font-weight: 600; cursor: pointer; color: #004a7c; font-size: 0.9rem; }
    .lang-btn.active { background: var(--egov-gold); color: #003357; }
    .user-bar { display: flex; align-items: center; gap: 20px; background: #eef6ff; padding: 8px 20px; border-radius: 40px; border: 1px solid #c2dcf0; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { font-size: 1.3rem; }
    .user-name { font-weight: 700; color: var(--egov-blue); }
    .balance-badge { background: var(--egov-gold); color: #003f5c; padding: 4px 14px; border-radius: 30px; font-weight: 700; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(245,197,66,0.3); }
    .content-area { flex: 1; margin: 40px 0; }
    .section-header { display: flex; align-items: center; gap: 14px; margin-bottom: 32px; }
    .section-header i { font-size: 2.2rem; color: var(--egov-gold); }
    .section-header h2 { font-size: 1.9rem; font-weight: 700; color: #003357; }
    .grid-2, .grid-3, .grid-4 { display: grid; gap: 28px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .card { background: white; border-radius: var(--egov-radius); padding: 28px 24px; box-shadow: var(--egov-shadow); transition: 0.2s; border-bottom: 5px solid transparent; cursor: pointer; }
    .card:hover { border-bottom-color: var(--egov-gold); transform: translateY(-5px); }
    .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; color: #00426a; }
    .stat-card { text-align: center; padding: 20px; }
    .stat-number { font-size: 2.8rem; font-weight: 800; color: var(--egov-blue); line-height: 1; margin-bottom: 8px; }
    .badge { background: #f0f7fe; padding: 6px 16px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: #004a7c; }
    .fake-input { background: #f6fafe; padding: 14px 18px; border-radius: 16px; border: 1px solid #cde0ea; display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .fake-input input, .fake-input select, .fake-input textarea { border: none; background: transparent; width: 100%; outline: none; resize: vertical; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,53,84,0.7); backdrop-filter: blur(6px); align-items: center; justify-content: center; z-index: 999; }
    .modal.active { display: flex; }
    .modal-content { background: white; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 40px; border-radius: 32px; box-shadow: 0 30px 50px rgba(0,0,0,0.2); }
    .map-container { height: 400px; width: 100%; border-radius: 18px; margin-top: 20px; z-index: 1; }
    .mini-map { height: 300px; width: 100%; border-radius: 16px; margin-bottom: 20px; z-index: 1; }
    .notification-bell { position: relative; cursor: pointer; }
    .notification-count { position: absolute; top: -8px; right: -8px; background: #e03a3a; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 700; }
    .footer { background: white; border-radius: 40px 40px 0 0; padding: 40px 0 20px; margin-top: 40px; box-shadow: 0 -8px 20px rgba(0,0,0,0.02); }
    .event-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: var(--egov-shadow); }
    .event-image { width: 100%; height: 180px; object-fit: cover; background: linear-gradient(145deg, #004a7c, #002e4a); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; }
    .event-info { padding: 20px; }
    .plan-detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid #eee; }
    .plan-detail-label { font-weight: 600; width: 200px; color: #004a7c; }
    .plan-detail-value { flex: 1; }
    .status-badge { padding: 4px 12px; border-radius: 30px; font-weight: 600; font-size: 0.8rem; }
    .status-active { background: #f5c542; color: #003357; }
    .status-completed { background: #0f6c4b; color: white; }
    .status-pending { background: #e68a2e; color: white; }
    @media (max-width: 1000px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .navbar-inner { flex-direction: column; gap: 15px; } .nav-and-user { flex-direction: column; } }
  </style>
</head>
<body>

<!-- ========== –ö–û–ù–§–ò–ì FIREBASE ========= -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCWgoXc-v5LalFfsbs9UJN-X-jcLwweTsY",
    authDomain: "udeee-8e07b.firebaseapp.com",
    databaseURL: "https://udeee-8e07b-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "udeee-8e07b",
    storageBucket: "udeee-8e07b.firebasestorage.app",
    messagingSenderId: "171875412311",
    appId: "1:171875412311:web:430d8f298e508f9556f612",
    measurementId: "G-GBMCGGF80Y"
  };
  firebase.initializeApp(firebaseConfig);
  const fbDB = firebase.database();
</script>

<!-- ========== –ú–û–î–ê–õ–ö–ò ========= -->
<!-- –ú–û–î–ê–õ–ö–ê –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
<div id="authModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h3 id="authModalTitle" style="color: #004a7c; font-size: 1.7rem; font-weight: 700;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeModal('authModal')"></i>
    </div>
    <div style="display: flex; flex-direction: column; gap: 24px;">
      <div style="display: flex; gap: 10px; border-bottom: 2px solid #eaf0f5; padding-bottom: 10px;">
        <button id="loginTabBtn" class="btn" style="flex:1;" onclick="showLoginForm()"><span data-i18n="login">–í—Ö–æ–¥</span></button>
        <button id="registerTabBtn" class="btn-outline" style="flex:1;" onclick="showRegisterForm()"><span data-i18n="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
      </div>
      <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
      <div id="loginForm">
        <div class="fake-input"><i class="fas fa-id-card"></i><input type="text" id="iinInput" placeholder="–ò–ò–ù (12 —Ü–∏—Ñ—Ä)" maxlength="12"></div>
        <div class="fake-input"><i class="fas fa-lock"></i><input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å"></div>
        <button class="btn" style="width:100%;" onclick="loginByIIN()"><i class="fas fa-arrow-right-to-bracket"></i> <span data-i18n="loginBtn">–í–æ–π—Ç–∏</span></button>
        <div style="margin-top:16px; text-align:center; color:#3a6e8c;" data-i18n="testCredentials">
          –¢–µ—Å—Ç: 100304223455/123 (–ê–∫–∏–º), 200105123456/123 (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å), 880101345678/123 (–ñ–∏—Ç–µ–ª—å)
        </div>
      </div>
      <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
      <div id="registerForm" style="display:none;">
        <div class="fake-input"><i class="fas fa-id-card"></i><input type="text" id="regIIN" placeholder="–ò–ò–ù (12 —Ü–∏—Ñ—Ä)" maxlength="12"></div>
        <div class="fake-input"><i class="fas fa-user"></i><input type="text" id="regName" placeholder="–§–ò–û"></div>
        <div class="fake-input"><i class="fas fa-lock"></i><input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)"></div>
        <button class="btn" style="width:100%; background:#0f6c4b;" onclick="registerCitizen()"><i class="fas fa-user-plus"></i> <span data-i18n="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span></button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –û–¢–ó–´–í–ê -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="color: #004a7c; font-size: 1.7rem;" id="reviewModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeReviewModal()"></i>
    </div>
    <div class="fake-input">
      <i class="fas fa-map-marker-alt"></i>
      <input type="text" id="reviewAddress" placeholder="–ê–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–ª. –ê–±–∞—è, 12)" value="—É–ª. –ê–±–∞—è, 12">
    </div>
    <div class="fake-input">
      <i class="fas fa-comment"></i>
      <textarea id="reviewText" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É...">–Ø–º–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ</textarea>
    </div>
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: 600;">–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ:</label>
      <div id="reviewMiniMap" class="mini-map"></div>
      <p style="margin-top: 10px; color: #004a7c;"><i class="fas fa-info-circle"></i> –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É</p>
    </div>
    <div style="display: flex; gap: 16px; justify-content: flex-end;">
      <button class="btn-outline" onclick="closeReviewModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" onclick="submitReview()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–õ–ê–ù–ê –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–ê -->
<div id="planModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="color: #004a7c; font-size: 1.7rem;" id="planModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closePlanModal()"></i>
    </div>
    <div class="fake-input">
      <i class="fas fa-hard-hat"></i>
      <input type="text" id="planTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" value="–ù–æ–≤–∞—è —à–∫–æ–ª–∞ ‚Ññ45">
    </div>
    <div class="fake-input">
      <i class="fas fa-map-marker-alt"></i>
      <input type="text" id="planAddress" placeholder="–ê–¥—Ä–µ—Å" value="—É–ª. –õ–µ–Ω–∏–Ω–∞, 45">
    </div>
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: 600;">–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ:</label>
      <div id="planMiniMap" class="mini-map"></div>
      <p style="margin-top: 10px; color: #004a7c;"><i class="fas fa-info-circle"></i> –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É</p>
    </div>
    
    <h4 style="margin: 20px 0 15px; color: #004a7c;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ</h4>
    
    <div class="fake-input">
      <i class="fas fa-tag"></i>
      <select id="planStatus">
        <option value="–Ω–µ –Ω–∞—á–∞—Ç–æ">–ù–µ –Ω–∞—á–∞—Ç–æ</option>
        <option value="–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è" selected>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</option>
        <option value="–≥–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
      </select>
    </div>
    
    <div class="fake-input">
      <i class="fas fa-building"></i>
      <input type="text" id="planBuilder" placeholder="–ü–æ–¥—Ä—è–¥—á–∏–∫ (–∫—Ç–æ —Å—Ç—Ä–æ–∏—Ç)" value="–¢–û–û –°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç">
    </div>
    
    <div class="fake-input">
      <i class="fas fa-file-contract"></i>
      <input type="text" id="planPermit" placeholder="–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–Ω–æ–º–µ—Ä)" value="–ê-123/2026">
    </div>
    
    <div class="grid-2" style="gap: 16px;">
      <div class="fake-input">
        <i class="fas fa-coins"></i>
        <input type="text" id="planBudget" placeholder="–û–±—â–∏–π –±—é–¥–∂–µ—Ç" value="450 –º–ª–Ω ‚Ç∏">
      </div>
      <div class="fake-input">
        <i class="fas fa-chart-line"></i>
        <input type="text" id="planMargin" placeholder="–ú–∞—Ä–∂–∞" value="15%">
      </div>
    </div>
    
    <div class="grid-2" style="gap: 16px;">
      <div class="fake-input">
        <i class="fas fa-users"></i>
        <input type="text" id="planSalary" placeholder="–ó–∞—Ä–ø–ª–∞—Ç—ã" value="12 –º–ª–Ω ‚Ç∏">
      </div>
      <div class="fake-input">
        <i class="fas fa-cubes"></i>
        <input type="text" id="planMaterials" placeholder="–ú–∞—Ç–µ—Ä–∏–∞–ª—ã" value="210 –º–ª–Ω ‚Ç∏">
      </div>
    </div>
    
    <div class="fake-input">
      <i class="fas fa-clock"></i>
      <input type="text" id="planLifetime" placeholder="–°—Ä–æ–∫ —Å–ª—É–∂–±—ã" value="50 –ª–µ—Ç">
    </div>
    
    <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn-outline" onclick="closePlanModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" onclick="addPlan()">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –ü–û–î–†–û–ë–ù–û–°–¢–ï–ô –ü–õ–ê–ù–ê –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–ê -->
<div id="planDetailModal" class="modal">
  <div class="modal-content" id="planDetailContent">
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –û–¢–í–ï–¢–ê –ù–ê –û–¢–ó–´–í -->
<div id="respondModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="color: #004a7c; font-size: 1.7rem;" id="respondModalTitle">–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Ç–∑—ã–≤</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeModal('respondModal')"></i>
    </div>
    <div id="respondReviewInfo" style="background: #f0f7fe; padding: 16px; border-radius: 16px; margin-bottom: 20px;">
      –û—Ç–≤–µ—Ç –¥–ª—è <strong>–ê–π–≥—É–ª—å –ú.</strong>
    </div>
    <div class="fake-input">
      <i class="fas fa-reply"></i>
      <textarea id="respondText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..."></textarea>
    </div>
    <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn-outline" onclick="closeModal('respondModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" onclick="sendResponse()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –û–ë–†–ê–©–ï–ù–ò–Ø –ö –ê–ö–ò–ú–£ -->
<div id="appealModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="color: #004a7c; font-size: 1.7rem;" id="appealModalTitle">–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∞–∫–∏–º—É</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeModal('appealModal')"></i>
    </div>
    <div class="fake-input">
      <i class="fas fa-id-card"></i>
      <input type="text" id="appealName" placeholder="–í–∞—à–µ –§–ò–û" readonly>
    </div>
    <div class="fake-input">
      <i class="fas fa-hashtag"></i>
      <input type="text" id="appealIIN" placeholder="–ò–ò–ù" readonly>
    </div>
    <div class="fake-input">
      <i class="fas fa-paper-plane"></i>
      <textarea id="appealText" rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ..."></textarea>
    </div>
    <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn-outline" onclick="closeModal('appealModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" onclick="sendAppeal()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –û–ü–õ–ê–¢–´ -->
<div id="paymentModal" class="modal">
  <div class="modal-content" id="paymentContent">
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
<div id="notificationsModal" class="modal">
  <div class="modal-content" id="notificationsContent">
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>
</div>

<!-- ========== –®–ê–ü–ö–ê (–ù–ê–í–ò–ì–ê–¶–ò–Ø –°–õ–ï–í–ê, –Æ–ó–ï–† –ò –ë–ê–õ–ê–ù–° –°–ü–†–ê–í–ê) ========= -->
<header class="navbar">
  <div class="container navbar-inner">
    <div class="logo"><i class="fas fa-tree"></i> EcoSemey</div>
    <div class="nav-and-user">
      <ul class="main-nav" id="navMenu"></ul>
      <div class="user-section">
        <div class="lang-switcher">
          <button class="lang-btn active" onclick="setLanguage('kz')">“ö–∞–∑</button>
          <button class="lang-btn" onclick="setLanguage('ru')">–†—É—Å</button>
          <button class="lang-btn" onclick="setLanguage('en')">Eng</button>
        </div>
        <div id="authBlock"></div>
      </div>
    </div>
  </div>
</header>

<!-- ========== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ========= -->
<main class="content-area container" id="dynamicContent"></main>

<!-- ========== –§–£–¢–ï–† ========= -->
<footer class="footer">
  <div class="container">
    <p style="text-align:center; color:#3e6a80;" data-i18n="footer">¬© 2026 ‚Äì –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≥. –°–µ–º–µ–π</p>
  </div>
</footer>

<script>
  // ========== –°–õ–û–í–ê–†–¨ –î–õ–Ø –ü–ï–†–ï–í–û–î–ê =========
  const translations = {
    kz: {
      home: "–ë–∞—Å—Ç—ã –±–µ—Ç",
      events: "–Ü—Å-—à–∞—Ä–∞–ª–∞—Ä",
      reviews: "–ü—ñ–∫—ñ—Ä–ª–µ—Ä",
      routes: "–ë–∞“ì—ã—Ç—Ç–∞—Ä",
      clinics: "–ï–º—Ö–∞–Ω–∞–ª–∞—Ä",
      police: "–ü–æ–ª–∏—Ü–∏—è",
      akimat: "”ò–∫—ñ–º–¥—ñ–∫",
      executors: "–û—Ä—ã–Ω–¥–∞—É—à—ã–ª–∞—Ä",
      citizens: "–¢“±—Ä“ì—ã–Ω–¥–∞—Ä",
      profile: "–ñ–µ–∫–µ –∫–∞–±–∏–Ω–µ—Ç",
      map: "–ö–∞—Ä—Ç–∞",
      login: "–ö—ñ—Ä—É",
      register: "–¢—ñ—Ä–∫–µ–ª—É",
      loginBtn: "–ö—ñ—Ä—É",
      registerBtn: "–¢—ñ—Ä–∫–µ–ª—É",
      testCredentials: "–¢–µ—Å—Ç: 100304223455/123 (”ò–∫—ñ–º), 200105123456/123 (–û—Ä—ã–Ω–¥–∞—É—à—ã), 880101345678/123 (–¢“±—Ä“ì—ã–Ω)",
      logout: "–®—ã“ì—É",
      footer: "¬© 2026 ‚Äì –°–µ–º–µ–π “õ–∞–ª–∞—Å—ã–Ω—ã“£ —Ü–∏—Ñ—Ä–ª—ã“õ —ç–∫–æ–∂“Ø–π–µ—Å—ñ",
      points: "–±–∞–ª–ª",
      balance: "–ë–∞–ª–∞–Ω—Å",
    },
    ru: {
      home: "–ì–ª–∞–≤–Ω–∞—è",
      events: "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
      reviews: "–û—Ç–∑—ã–≤—ã",
      routes: "–ú–∞—Ä—à—Ä—É—Ç—ã",
      clinics: "–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏",
      police: "–ü–æ–ª–∏—Ü–∏—è",
      akimat: "–ê–∫–∏–º–∞—Ç",
      executors: "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏",
      citizens: "–ñ–∏—Ç–µ–ª–∏",
      profile: "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
      map: "–ö–∞—Ä—Ç–∞",
      login: "–í—Ö–æ–¥",
      register: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
      loginBtn: "–í–æ–π—Ç–∏",
      registerBtn: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
      testCredentials: "–¢–µ—Å—Ç: 100304223455/123 (–ê–∫–∏–º), 200105123456/123 (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å), 880101345678/123 (–ñ–∏—Ç–µ–ª—å)",
      logout: "–í—ã–π—Ç–∏",
      footer: "¬© 2026 ‚Äì –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≥. –°–µ–º–µ–π",
      points: "–±–∞–ª–ª–æ–≤",
      balance: "–ë–∞–ª–∞–Ω—Å",
    },
    en: {
      home: "Home",
      events: "Events",
      reviews: "Reviews",
      routes: "Routes",
      clinics: "Clinics",
      police: "Police",
      akimat: "Akimat",
      executors: "Executors",
      citizens: "Citizens",
      profile: "Profile",
      map: "Map",
      login: "Login",
      register: "Register",
      loginBtn: "Sign In",
      registerBtn: "Register",
      testCredentials: "Test: 100304223455/123 (Akim), 200105123456/123 (Executor), 880101345678/123 (Citizen)",
      logout: "Logout",
      footer: "¬© 2026 ‚Äì Digital ecosystem of Semey",
      points: "points",
      balance: "Balance",
    }
  };

  let currentLang = 'ru'; // –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

  // ========== –§–£–ù–ö–¶–ò–Ø –°–ú–ï–ù–´ –Ø–ó–´–ö–ê =========
  function setLanguage(lang) {
    currentLang = lang;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    renderNavigation();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    renderAuthBlock();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª
    const activeSection = document.querySelector('.nav-link.active')?.dataset.section || 'home';
    switchSection(activeSection);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –º–æ–¥–∞–ª–∫–∞—Ö
    applyTranslations();
  }

  // ========== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–ï–†–ï–í–û–î–û–í =========
  function applyTranslations() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[currentLang][key]) {
        el.textContent = translations[currentLang][key];
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–¥–∞–ª–æ–∫
    const authModalTitle = document.getElementById('authModalTitle');
    if (authModalTitle) {
      authModalTitle.textContent = currentLang === 'kz' ? '–ö—ñ—Ä—É / –¢—ñ—Ä–∫–µ–ª—É' : 
                                   currentLang === 'en' ? 'Login / Register' : '–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
    }
    
    const reviewModalTitle = document.getElementById('reviewModalTitle');
    if (reviewModalTitle) {
      reviewModalTitle.textContent = currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä “õ–æ—Å—É' :
                                    currentLang === 'en' ? 'Add review' : '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
    }
    
    const planModalTitle = document.getElementById('planModalTitle');
    if (planModalTitle) {
      planModalTitle.textContent = currentLang === 'kz' ? '“ö“±—Ä—ã–ª—ã—Å –∂–æ—Å–ø–∞—Ä—ã–Ω “õ–æ—Å—É' :
                                  currentLang === 'en' ? 'Add construction plan' : '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞';
    }
    
    const respondModalTitle = document.getElementById('respondModalTitle');
    if (respondModalTitle) {
      respondModalTitle.textContent = currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä–≥–µ –∂–∞—É–∞–ø –±–µ—Ä—É' :
                                     currentLang === 'en' ? 'Respond to review' : '–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Ç–∑—ã–≤';
    }
    
    const appealModalTitle = document.getElementById('appealModalTitle');
    if (appealModalTitle) {
      appealModalTitle.textContent = currentLang === 'kz' ? '”ò–∫—ñ–º–≥–µ –∂–µ–∫–µ ”©—Ç—ñ–Ω—ñ—à' :
                                    currentLang === 'en' ? 'Personal appeal to the akim' : '–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∞–∫–∏–º—É';
    }
  }

  // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =========
  let currentUser = null;
  let map = null;
  let reviewMap = null;
  let planMap = null;
  let reviewMarker = null;
  let planMarker = null;
  let currentRespondReviewId = null;

  // ========== –§–£–ù–ö–¶–ò–ò FIREBASE =========
  async function getUsers() { const snap = await fbDB.ref('users').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveUsers(users) { const obj = {}; users.forEach((u,i)=>obj[i]=u); await fbDB.ref('users').set(obj); }
  async function findUserByIIN(iin) {
    const snap = await fbDB.ref('users').orderByChild('iin').equalTo(iin).once('value');
    const data = snap.val();
    return data ? Object.values(data)[0] : null;
  }
  async function getReviews() { const snap = await fbDB.ref('reviews').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveReviews(reviews) { const obj = {}; reviews.forEach((r,i)=>obj[i]=r); await fbDB.ref('reviews').set(obj); }
  async function getPlans() { const snap = await fbDB.ref('construction_plans').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function savePlans(plans) { const obj = {}; plans.forEach((p,i)=>obj[i]=p); await fbDB.ref('construction_plans').set(obj); }
  async function getNotifications() { const snap = await fbDB.ref('notifications').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveNotifications(notifs) { const obj = {}; notifs.forEach((n,i)=>obj[i]=n); await fbDB.ref('notifications').set(obj); }
  async function getEmployees() { const snap = await fbDB.ref('employees').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveEmployees(emps) { const obj = {}; emps.forEach((e,i)=>obj[i]=e); await fbDB.ref('employees').set(obj); }

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ =========
  async function initFirebase() {
    if (!(await fbDB.ref('users').once('value')).exists()) {
      await saveUsers([
        { iin: "100304223455", password: "123", role: "akim", name: "–ù—É—Ä—Å—É–ª—Ç–∞–Ω –ê.", avatar: "üë§", points: 1000 },
        { iin: "200105123456", password: "123", role: "ispolnitel", name: "–ë–µ—Ä–∏–∫ –ö.", avatar: "üîß", points: 500 },
        { iin: "880101345678", password: "123", role: "citizen", name: "–ê–π–≥—É–ª—å –ú.", avatar: "üè†", points: 250 },
        { iin: "900202112233", password: "123", role: "citizen", name: "–†—É—Å–ª–∞–Ω –¢.", avatar: "üè†", points: 120 }
      ]);
    }
    if (!(await fbDB.ref('employees').once('value')).exists()) {
      await saveEmployees([
        { id: 1, name: "–°–µ—Ä–∏–∫ –ê–±–∏—à–µ–≤", position: "–ë—Ä–∏–≥–∞–¥–∏—Ä", status: "active", rating: 4.5 },
        { id: 2, name: "–ê–π–Ω—É—Ä –°–∞–≥–∏–Ω—Ç–∞–µ–≤–∞", position: "–ú–∞—Å—Ç–µ—Ä –ñ–ö–•", status: "active", rating: 4.8 }
      ]);
    }
    if (!(await fbDB.ref('reviews').once('value')).exists()) {
      await saveReviews([
        { id: 1, userId: "880101345678", userName: "–ê–π–≥—É–ª—å –ú.", lat: 50.411, lng: 80.227, address: "—É–ª. –ê–±–∞—è, 12", text: "–Ø–º–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ —É–ª. –ê–±–∞—è", photo: null, rating: 0, points: 0, status: "active", date: "2026-02-20", responses: [], pointsAwarded: false }
      ]);
    }
    if (!(await fbDB.ref('construction_plans').once('value')).exists()) {
      await savePlans([
        { 
          id: 1, 
          lat: 50.419, 
          lng: 80.245, 
          address: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 45", 
          title: "–ù–æ–≤–∞—è —à–∫–æ–ª–∞ ‚Ññ45", 
          status: "–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è", 
          builder: "–¢–û–û –°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç", 
          permit: "–ê-123/2026", 
          budget: "450 –º–ª–Ω ‚Ç∏", 
          margin: "15%", 
          salary: "12 –º–ª–Ω ‚Ç∏", 
          materials: "210 –º–ª–Ω ‚Ç∏", 
          lifetime: "50 –ª–µ—Ç", 
          photos: [], 
          videos: [], 
          reports: [], 
          createdBy: "akim" 
        }
      ]);
    }
    if (!(await fbDB.ref('notifications').once('value')).exists()) {
      await saveNotifications([
        { id: 1, from: "–°–∏—Å—Ç–µ–º–∞", to: "all", text: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ü–∏—Ñ—Ä–æ–≤—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É –°–µ–º–µ—è!", date: new Date().toLocaleDateString(), read: false }
      ]);
    }
  }

  // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø =========
  async function loginByIIN() {
    const iin = document.getElementById('iinInput')?.value.trim();
    const pwd = document.getElementById('passwordInput')?.value.trim();
    if (!iin || !pwd) return alert(currentLang === 'kz' ? '–ò–ò–ù –º–µ–Ω –ø–∞—Ä–æ–ª—å–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter IIN and password' : '–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù –∏ –ø–∞—Ä–æ–ª—å');
    const user = await findUserByIIN(iin);
    if (!user) return alert(currentLang === 'kz' ? '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã' : currentLang === 'en' ? 'User not found' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    if (user.password !== pwd) return alert(currentLang === 'kz' ? '“ö–∞—Ç–µ –ø–∞—Ä–æ–ª—å' : currentLang === 'en' ? 'Invalid password' : '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    currentUser = user;
    closeModal('authModal');
    renderNavigation();
    renderAuthBlock();
    switchSection('home');
  }
  
  async function registerCitizen() {
    const iin = document.getElementById('regIIN').value.trim();
    const name = document.getElementById('regName').value.trim();
    const pwd = document.getElementById('regPassword').value.trim();
    if (!iin || !name || !pwd) return alert(currentLang === 'kz' ? '–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑' : currentLang === 'en' ? 'Fill in all fields' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    if (iin.length !== 12 || !/^\d+$/.test(iin)) return alert(currentLang === 'kz' ? '–ò–ò–ù 12 —Ü–∏—Ñ—Ä–¥–∞–Ω —Ç“±—Ä—É—ã –∫–µ—Ä–µ–∫' : currentLang === 'en' ? 'IIN must be 12 digits' : '–ò–ò–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 12 —Ü–∏—Ñ—Ä');
    if (pwd.length < 4) return alert(currentLang === 'kz' ? '–ü–∞—Ä–æ–ª—å –∫–µ–º—ñ–Ω–¥–µ 4 —Å–∏–º–≤–æ–ª' : currentLang === 'en' ? 'Password must be at least 4 characters' : '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
    if (await findUserByIIN(iin)) return alert(currentLang === 'kz' ? '–ò–ò–ù —Ç—ñ—Ä–∫–µ–ª–≥–µ–Ω' : currentLang === 'en' ? 'IIN is already registered' : '–ò–ò–ù —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
    const users = await getUsers();
    users.push({ iin, password: pwd, role: "citizen", name, avatar: "üè†", points: 0 });
    await saveUsers(users);
    alert(currentLang === 'kz' ? '–¢—ñ—Ä–∫–µ–ª—É —Å”ô—Ç—Ç—ñ! –ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—ñ“£—ñ–∑.' : currentLang === 'en' ? 'Registration successful! Please login.' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ.');
    showLoginForm();
    document.getElementById('iinInput').value = iin;
  }
  
  function logout() { 
    currentUser = null; 
    renderNavigation(); 
    renderAuthBlock(); 
    switchSection('home'); 
  }

  // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò =========
  function openModal(id) { 
    document.getElementById(id).classList.add('active'); 
  }
  
  function closeModal(id) { 
    document.getElementById(id).classList.remove('active'); 
  }
  
  function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginTabBtn').className = 'btn';
    document.getElementById('registerTabBtn').className = 'btn-outline';
  }
  
  function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('registerTabBtn').className = 'btn';
    document.getElementById('loginTabBtn').className = 'btn-outline';
  }

  // ========== –ú–û–î–ê–õ–ö–ê –û–¢–ó–´–í–ê =========
  function openReviewModal() {
    openModal('reviewModal');
    setTimeout(() => {
      if (document.getElementById('reviewMiniMap')) {
        initReviewMap();
      }
    }, 200);
  }
  
  function closeReviewModal() {
    closeModal('reviewModal');
    if (reviewMap) {
      reviewMap.remove();
      reviewMap = null;
    }
  }
  
  function initReviewMap() {
    if (reviewMap) {
      reviewMap.remove();
    }
    reviewMap = L.map('reviewMiniMap').setView([50.411, 80.227], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    }).addTo(reviewMap);
    
    reviewMarker = null;
    
    reviewMap.on('click', function(e) {
      if (reviewMarker) {
        reviewMap.removeLayer(reviewMarker);
      }
      reviewMarker = L.marker(e.latlng).addTo(reviewMap);
      reviewMarker.bindPopup('–ú–µ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã').openPopup();
    });
  }
  
  async function submitReview() {
    if (!currentUser) {
      alert(currentLang === 'kz' ? '–ê–ª–¥—ã–º–µ–Ω –∂“Ø–π–µ–≥–µ –∫—ñ—Ä—ñ“£—ñ–∑' : currentLang === 'en' ? 'Please login first' : '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
      return;
    }
    
    const address = document.getElementById('reviewAddress').value.trim();
    const text = document.getElementById('reviewText').value.trim();
    
    if (!address || !text) {
      alert(currentLang === 'kz' ? '–ú–µ–∫–µ–Ω–∂–∞–π –º–µ–Ω –º”ô—Ç—ñ–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter address and text' : '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ —Ç–µ–∫—Å—Ç');
      return;
    }
    
    if (!reviewMarker) {
      alert(currentLang === 'kz' ? '–ö–∞—Ä—Ç–∞–¥–∞–Ω –æ—Ä—ã–Ω–¥—ã –±–µ–ª–≥—ñ–ª–µ“£—ñ–∑' : currentLang === 'en' ? 'Mark a location on the map' : '–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
      return;
    }
    
    const lat = reviewMarker.getLatLng().lat;
    const lng = reviewMarker.getLatLng().lng;
    
    const reviews = await getReviews();
    const newId = reviews.length ? Math.max(...reviews.map(r => r.id)) + 1 : 1;
    
    reviews.push({
      id: newId,
      userId: currentUser.iin,
      userName: currentUser.name,
      lat: lat,
      lng: lng,
      address: address,
      text: text,
      photo: null,
      rating: 0,
      points: 0,
      status: "active",
      date: new Date().toISOString().split('T')[0],
      responses: [],
      pointsAwarded: false
    });
    
    await saveReviews(reviews);
    alert(currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä “õ–æ—Å—ã–ª–¥—ã!' : currentLang === 'en' ? 'Review added!' : '–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω!');
    closeReviewModal();
    
    if (document.querySelector('.nav-link.active')?.dataset.section === 'map') {
      await initMap();
    }
  }

  // ========== –ú–û–î–ê–õ–ö–ê –ü–õ–ê–ù–ê –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–ê =========
  function openPlanModal() {
    openModal('planModal');
    setTimeout(() => {
      if (document.getElementById('planMiniMap')) {
        initPlanMap();
      }
    }, 200);
  }
  
  function closePlanModal() {
    closeModal('planModal');
    if (planMap) {
      planMap.remove();
      planMap = null;
    }
  }
  
  function initPlanMap() {
    if (planMap) {
      planMap.remove();
    }
    planMap = L.map('planMiniMap').setView([50.411, 80.227], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    }).addTo(planMap);
    
    planMarker = null;
    
    planMap.on('click', function(e) {
      if (planMarker) {
        planMap.removeLayer(planMarker);
      }
      planMarker = L.marker(e.latlng).addTo(planMap);
      planMarker.bindPopup('–ú–µ—Å—Ç–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞').openPopup();
    });
  }
  
  async function addPlan() {
    if (!currentUser) {
      alert(currentLang === 'kz' ? '–ê–ª–¥—ã–º–µ–Ω –∂“Ø–π–µ–≥–µ –∫—ñ—Ä—ñ“£—ñ–∑' : currentLang === 'en' ? 'Please login first' : '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
      return;
    }
    
    const title = document.getElementById('planTitle').value.trim();
    const address = document.getElementById('planAddress').value.trim();
    const status = document.getElementById('planStatus').value;
    const builder = document.getElementById('planBuilder').value.trim();
    const permit = document.getElementById('planPermit').value.trim();
    const budget = document.getElementById('planBudget').value.trim();
    const margin = document.getElementById('planMargin').value.trim();
    const salary = document.getElementById('planSalary').value.trim();
    const materials = document.getElementById('planMaterials').value.trim();
    const lifetime = document.getElementById('planLifetime').value.trim();
    
    if (!title || !address) {
      alert(currentLang === 'kz' ? '–ê—Ç–∞—É—ã –º–µ–Ω –º–µ–∫–µ–Ω–∂–∞–π—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter title and address' : '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');
      return;
    }
    
    if (!planMarker) {
      alert(currentLang === 'kz' ? '–ö–∞—Ä—Ç–∞–¥–∞–Ω –æ—Ä—ã–Ω–¥—ã –±–µ–ª–≥—ñ–ª–µ“£—ñ–∑' : currentLang === 'en' ? 'Mark a location on the map' : '–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
      return;
    }
    
    const lat = planMarker.getLatLng().lat;
    const lng = planMarker.getLatLng().lng;
    
    const plans = await getPlans();
    const newId = plans.length ? Math.max(...plans.map(p => p.id)) + 1 : 1;
    
    plans.push({
      id: newId,
      lat: lat,
      lng: lng,
      address: address,
      title: title,
      status: status,
      builder: builder || "–ù–µ —É–∫–∞–∑–∞–Ω",
      permit: permit || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
      budget: budget || "–ù–µ —É–∫–∞–∑–∞–Ω",
      margin: margin || "–ù–µ —É–∫–∞–∑–∞–Ω–∞",
      salary: salary || "–ù–µ —É–∫–∞–∑–∞–Ω–∞",
      materials: materials || "–ù–µ —É–∫–∞–∑–∞–Ω—ã",
      lifetime: lifetime || "–ù–µ —É–∫–∞–∑–∞–Ω",
      photos: [],
      videos: [],
      reports: [],
      createdBy: currentUser.role,
      createdDate: new Date().toISOString().split('T')[0]
    });
    
    await savePlans(plans);
    alert(currentLang === 'kz' ? '“ö“±—Ä—ã–ª—ã—Å –∂–æ—Å–ø–∞—Ä—ã “õ–æ—Å—ã–ª–¥—ã!' : currentLang === 'en' ? 'Construction plan added!' : '–ü–ª–∞–Ω —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω!');
    closePlanModal();
    
    if (document.querySelector('.nav-link.active')?.dataset.section === 'map') {
      await initMap();
    }
  }
  
  // ========== –ú–û–î–ê–õ–ö–ê –ü–û–î–†–û–ë–ù–û–°–¢–ï–ô –ü–õ–ê–ù–ê =========
  async function showPlanDetail(planId) {
    const plans = await getPlans();
    const plan = plans.find(p => p.id === planId);
    
    if (!plan) return;
    
    const statusClass = plan.status === '–≥–æ—Ç–æ–≤–æ' ? 'status-completed' : 
                       (plan.status === '–Ω–µ –Ω–∞—á–∞—Ç–æ' ? 'status-pending' : 'status-active');
    
    const statusText = currentLang === 'kz' ? 
                      (plan.status === '–≥–æ—Ç–æ–≤–æ' ? '–î–∞–π—ã–Ω' : 
                       plan.status === '–Ω–µ –Ω–∞—á–∞—Ç–æ' ? '–ë–∞—Å—Ç–∞–ª–º–∞“ì–∞–Ω' : '–û—Ä—ã–Ω–¥–∞–ª—É–¥–∞') :
                      currentLang === 'en' ?
                      (plan.status === '–≥–æ—Ç–æ–≤–æ' ? 'Completed' : 
                       plan.status === '–Ω–µ –Ω–∞—á–∞—Ç–æ' ? 'Not started' : 'In progress') :
                      plan.status;
    
    const html = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #004a7c; font-size: 1.7rem;">${plan.title}</h3>
        <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeModal('planDetailModal')"></i>
      </div>
      
      <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1; min-width: 200px;">
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ú–µ–∫–µ–Ω–∂–∞–π' : currentLang === 'en' ? 'Address' : '–ê–¥—Ä–µ—Å'}:</span>
            <span class="plan-detail-value">${plan.address}</span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ú”ô—Ä—Ç–µ–±–µ' : currentLang === 'en' ? 'Status' : '–°—Ç–∞—Ç—É—Å'}:</span>
            <span class="plan-detail-value"><span class="status-badge ${statusClass}">${statusText}</span></span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ú–µ—Ä–¥—ñ–≥–µ—Ä' : currentLang === 'en' ? 'Builder' : '–ü–æ–¥—Ä—è–¥—á–∏–∫'}:</span>
            <span class="plan-detail-value">${plan.builder}</span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–†“±“õ—Å–∞—Ç' : currentLang === 'en' ? 'Permit' : '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ'}:</span>
            <span class="plan-detail-value">${plan.permit}</span>
          </div>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ë—é–¥–∂–µ—Ç' : currentLang === 'en' ? 'Budget' : '–ë—é–¥–∂–µ—Ç'}:</span>
            <span class="plan-detail-value"><strong style="color: #004a7c;">${plan.budget}</strong></span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ú–∞—Ä–∂–∞' : currentLang === 'en' ? 'Margin' : '–ú–∞—Ä–∂–∞'}:</span>
            <span class="plan-detail-value">${plan.margin}</span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ñ–∞–ª–∞“õ—ã–ª–∞—Ä' : currentLang === 'en' ? 'Salaries' : '–ó–∞—Ä–ø–ª–∞—Ç—ã'}:</span>
            <span class="plan-detail-value">${plan.salary}</span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '–ú–∞—Ç–µ—Ä–∏–∞–ª–¥–∞—Ä' : currentLang === 'en' ? 'Materials' : '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã'}:</span>
            <span class="plan-detail-value">${plan.materials}</span>
          </div>
          <div class="plan-detail-row">
            <span class="plan-detail-label">${currentLang === 'kz' ? '“ö—ã–∑–º–µ—Ç –º–µ—Ä–∑—ñ–º—ñ' : currentLang === 'en' ? 'Lifetime' : '–°—Ä–æ–∫ —Å–ª—É–∂–±—ã'}:</span>
            <span class="plan-detail-value">${plan.lifetime}</span>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: #6c8fa0; font-size: 0.9rem;">
          <i class="fas fa-calendar"></i> 
          ${currentLang === 'kz' ? '“ö–æ—Å—ã–ª“ì–∞–Ω' : currentLang === 'en' ? 'Added' : '–î–æ–±–∞–≤–ª–µ–Ω–æ'}: ${plan.createdDate || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'} | 
          <i class="fas fa-user"></i> 
          ${currentLang === 'kz' ? '–ê–≤—Ç–æ—Ä' : currentLang === 'en' ? 'Author' : '–ê–≤—Ç–æ—Ä'}: ${plan.createdBy === 'akim' ? (currentLang === 'kz' ? '”ò–∫—ñ–º' : currentLang === 'en' ? 'Akim' : '–ê–∫–∏–º') : 
            (plan.createdBy === 'ispolnitel' ? (currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å') : 
            (currentLang === 'kz' ? '–¢“±—Ä“ì—ã–Ω' : currentLang === 'en' ? 'Citizen' : '–ñ–∏—Ç–µ–ª—å'))}
        </p>
      </div>
      
      <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn-outline" onclick="closeModal('planDetailModal')">${currentLang === 'kz' ? '–ñ–∞–±—É' : currentLang === 'en' ? 'Close' : '–ó–∞–∫—Ä—ã—Ç—å'}</button>
      </div>
    `;
    
    document.getElementById('planDetailContent').innerHTML = html;
    openModal('planDetailModal');
  }

  // ========== –ö–ê–†–¢–ê –° –ù–û–†–ú–ê–õ–¨–ù–´–ú–ò –ó–ù–ê–ß–ö–ê–ú–ò =========
  function getMarkerIcon(type) {
    if (type === 'review') return L.divIcon({ html: '<i class="fas fa-comment" style="color:#004a7c; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'plan') return L.divIcon({ html: '<i class="fas fa-hard-hat" style="color:#f5c542; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'police') return L.divIcon({ html: '<i class="fas fa-shield-haltered" style="color:#d32f2f; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'clinic') return L.divIcon({ html: '<i class="fas fa-plus-circle" style="color:#2e7d32; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    return L.divIcon({ html: '<i class="fas fa-map-marker" style="color:#004a7c; font-size:24px;"></i>', iconSize: [30,30] });
  }

  async function renderMap() {
    return `<div class="section-header"><i class="fas fa-map"></i><h2>${currentLang === 'kz' ? '–°–µ–º–µ–π –∫–∞—Ä—Ç–∞—Å—ã' : currentLang === 'en' ? 'Semey Map' : '–ö–∞—Ä—Ç–∞ –°–µ–º–µ—è'}</h2></div>
      <div id="mapContainer" class="map-container"></div>
      <div style="margin-top:20px;">
        ${currentUser ? `<button class="btn" onclick="openReviewModal()"><i class="fas fa-plus-circle"></i> ${currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä “õ–æ—Å—É' : currentLang === 'en' ? 'Add review' : '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤'}</button>` : ''}
        ${currentUser && (currentUser.role === 'akim' || currentUser.role === 'ispolnitel') ? `<button class="btn" style="margin-left:16px;" onclick="openPlanModal()"><i class="fas fa-hard-hat"></i> ${currentLang === 'kz' ? '“ö“±—Ä—ã–ª—ã—Å –∂–æ—Å–ø–∞—Ä—ã–Ω “õ–æ—Å—É' : currentLang === 'en' ? 'Add construction plan' : '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞'}</button>` : ''}
      </div>`;
  }

  async function initMap() {
    if (!document.getElementById('mapContainer')) return;
    if (map) map.remove();
    map = L.map('mapContainer').setView([50.411, 80.227], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    }).addTo(map);

    const reviews = await getReviews();
    reviews.forEach(r => {
      if (r.status === 'active' && r.lat && r.lng) {
        const marker = L.marker([r.lat, r.lng], { icon: getMarkerIcon('review') }).addTo(map);
        let popupContent = `<b>${r.userName}</b><br>${r.text}<br>‚≠ê ${r.rating} | üèÖ ${r.points || 0} ${currentLang === 'kz' ? '–±–∞–ª–ª' : currentLang === 'en' ? 'points' : '–±–∞–ª–ª–æ–≤'}<br>`;
        if (r.address) popupContent += `<i>${r.address}</i><br>`;
        if (currentUser?.role === 'akim' && !r.pointsAwarded) {
          popupContent += `<button onclick="approveReview(${r.id})" style="margin:2px; background:#004a7c; color:white; border:none; padding:5px 10px; border-radius:20px;">+500 ${currentLang === 'kz' ? '–±–∞–ª–ª' : currentLang === 'en' ? 'points' : '–±–∞–ª–ª–æ–≤'}</button>`;
        }
        if (currentUser?.role === 'akim' || currentUser?.role === 'ispolnitel') {
          popupContent += `<button onclick="openRespondModal(${r.id}, '${r.userName}')" style="margin:2px; background:#f5c542; color:#003f5c; border:none; padding:5px 10px; border-radius:20px;">${currentLang === 'kz' ? '–ñ–∞—É–∞–ø –±–µ—Ä—É' : currentLang === 'en' ? 'Respond' : '–û—Ç–≤–µ—Ç–∏—Ç—å'}</button>`;
        }
        marker.bindPopup(popupContent);
      }
    });

    const plans = await getPlans();
    plans.forEach(p => {
      if (p.lat && p.lng) {
        const marker = L.marker([p.lat, p.lng], { icon: getMarkerIcon('plan') }).addTo(map);
        marker.bindPopup(`<b>${p.title}</b><br>${currentLang === 'kz' ? '–ú”ô—Ä—Ç–µ–±–µ' : currentLang === 'en' ? 'Status' : '–°—Ç–∞—Ç—É—Å'}: ${p.status}<br><button onclick="showPlanDetail(${p.id})" style="background:#004a7c; color:white; border:none; padding:8px 16px; border-radius:30px; margin-top:8px; cursor:pointer;">${currentLang === 'kz' ? '–¢–æ–ª—ã“ì—ã—Ä–∞“õ' : currentLang === 'en' ? 'Details' : '–ü–æ–¥—Ä–æ–±–Ω–µ–µ'}</button>`);
      }
    });

    const policeStations = getPoliceStations();
    policeStations.forEach(p => {
      const marker = L.marker([p.lat, p.lng], { icon: getMarkerIcon('police') }).addTo(map);
      marker.bindPopup(`<b>${p.name}</b><br>${p.address}<br>üìû ${p.phone}`);
    });

    const clinics = [
      { name: currentLang === 'kz' ? '‚Ññ1 “õ–∞–ª–∞–ª—ã“õ –µ–º—Ö–∞–Ω–∞' : currentLang === 'en' ? 'City Polyclinic ‚Ññ1' : '–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ1', address: currentLang === 'kz' ? '”ò—É–µ–∑–æ–≤ –∫-—Å—ñ, 12' : currentLang === 'en' ? 'Auezov str., 12' : '—É–ª. –ê—É—ç–∑–æ–≤–∞, 12', phone: "8 (7222) 56-78-90", lat: 50.409, lng: 80.230 },
      { name: currentLang === 'kz' ? '‚Ññ3 –±–∞–ª–∞–ª–∞—Ä –µ–º—Ö–∞–Ω–∞—Å—ã' : currentLang === 'en' ? 'Children\'s Polyclinic ‚Ññ3' : '–î–µ—Ç—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ3', address: currentLang === 'kz' ? '“ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä –∫-—Å—ñ, 45' : currentLang === 'en' ? 'Kabanbay batyr str., 45' : '—É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞, 45', phone: "8 (7222) 33-22-11", lat: 50.415, lng: 80.240 }
    ];
    clinics.forEach(c => {
      const marker = L.marker([c.lat, c.lng], { icon: getMarkerIcon('clinic') }).addTo(map);
      marker.bindPopup(`<b>${c.name}</b><br>${c.address}<br>üìû ${c.phone}`);
    });
  }

  // ========== –ê–ö–ò–ú: –ë–ê–õ–õ–´ =========
  window.approveReview = async function(id) {
    let reviews = await getReviews();
    let rev = reviews.find(r => r.id === id);
    if (!rev) return;
    if (rev.pointsAwarded) {
      alert(currentLang === 'kz' ? '–ë“±–ª –ø—ñ–∫—ñ—Ä–≥–µ –±–∞–ª–ª–¥–∞—Ä –±“±—Ä—ã–Ω–Ω–∞–Ω –±–µ—Ä—ñ–ª–≥–µ–Ω (–º–∞–∫—Å–∏–º—É–º 500)' : currentLang === 'en' ? 'Points have already been awarded for this review (maximum 500)' : '–ó–∞ —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤ —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –±–∞–ª–ª—ã (–º–∞–∫—Å–∏–º—É–º 500)');
      return;
    }
    rev.points = (rev.points || 0) + 500;
    rev.pointsAwarded = true;
    rev.rating = Math.min(5, rev.rating + 1);
    await saveReviews(reviews);
    let users = await getUsers();
    let user = users.find(u => u.iin === rev.userId);
    if (user) {
      user.points = (user.points || 0) + 500;
      if (currentUser && currentUser.iin === user.iin) currentUser.points = user.points;
      await saveUsers(users);
    }
    alert(currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä —Ä–∞—Å—Ç–∞–ª–¥—ã, —Ç“±—Ä“ì—ã–Ω“ì–∞ +500 –±–∞–ª–ª' : currentLang === 'en' ? 'Review confirmed, +500 points to the citizen' : '–û—Ç–∑—ã–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, +500 –±–∞–ª–ª–æ–≤ –∂–∏—Ç–µ–ª—é');
    renderAuthBlock();
    if (document.querySelector('.nav-link.active')?.dataset.section === 'map') await initMap();
  };

  window.openRespondModal = function(reviewId, userName) {
    currentRespondReviewId = reviewId;
    document.getElementById('respondReviewInfo').innerHTML = `${currentLang === 'kz' ? '–ñ–∞—É–∞–ø' : currentLang === 'en' ? 'Response for' : '–û—Ç–≤–µ—Ç –¥–ª—è'} <strong>${userName}</strong>`;
    document.getElementById('respondText').value = '';
    openModal('respondModal');
  };
  
  window.sendResponse = async function() {
    const text = document.getElementById('respondText').value.trim();
    if (!text) return alert(currentLang === 'kz' ? '–ñ–∞—É–∞–ø –º”ô—Ç—ñ–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter the response text' : '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
    const reviews = await getReviews();
    const review = reviews.find(r => r.id === currentRespondReviewId);
    if (!review) return;
    if (!review.responses) review.responses = [];
    review.responses.push({
      from: currentUser.name,
      role: currentUser.role,
      text: text,
      date: new Date().toLocaleDateString()
    });
    await saveReviews(reviews);
    const nots = await getNotifications();
    nots.push({
      id: Date.now(),
      from: `${currentUser.role === 'akim' ? (currentLang === 'kz' ? '”ò–∫—ñ–º' : currentLang === 'en' ? 'Akim' : '–ê–∫–∏–º') : (currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å')} ${currentUser.name}`,
      to: 'user',
      userIin: review.userId,
      text: `${currentLang === 'kz' ? '–°—ñ–∑–¥—ñ“£ –ø—ñ–∫—ñ—Ä—ñ“£—ñ–∑–≥–µ –∂–∞—É–∞–ø' : currentLang === 'en' ? 'Response to your review' : '–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –æ—Ç–∑—ã–≤'}: ${text}`,
      date: new Date().toLocaleDateString(),
      read: false
    });
    await saveNotifications(nots);
    alert(currentLang === 'kz' ? '–ñ–∞—É–∞–ø –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!' : currentLang === 'en' ? 'Response sent!' : '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
    closeModal('respondModal');
  };

  // ========== –û–ë–†–ê–©–ï–ù–ò–ï –ö –ê–ö–ò–ú–£ =========
  window.openAppealModal = function() {
    document.getElementById('appealName').value = currentUser.name;
    document.getElementById('appealIIN').value = currentUser.iin;
    document.getElementById('appealText').value = '';
    openModal('appealModal');
  };
  
  window.sendAppeal = async function() {
    const text = document.getElementById('appealText').value.trim();
    if (!text) return alert(currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à –º”ô—Ç—ñ–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter the appeal text' : '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è');
    const nots = await getNotifications();
    nots.push({
      id: Date.now(),
      from: `${currentLang === 'kz' ? '–¢“±—Ä“ì—ã–Ω' : currentLang === 'en' ? 'Citizen' : '–ñ–∏—Ç–µ–ª—å'} ${currentUser.name}`,
      to: 'role',
      role: 'akim',
      text: `${currentLang === 'kz' ? '–ñ–µ–∫–µ ”©—Ç—ñ–Ω—ñ—à' : currentLang === 'en' ? 'Personal appeal' : '–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ'}: ${text}`,
      date: new Date().toLocaleDateString(),
      read: false
    });
    await saveNotifications(nots);
    alert(currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à—ñ“£—ñ–∑ ”ô–∫—ñ–º–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!' : currentLang === 'en' ? 'Your appeal has been sent to the akim!' : '–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–∫–∏–º—É!');
    closeModal('appealModal');
  };

  // ========== –†–ï–ù–î–ï–† –ù–ê–í–ò–ì–ê–¶–ò–ò =========
  function renderNavigation() {
    const nav = document.getElementById('navMenu'); 
    nav.innerHTML = '';
    let items = [
      { id: 'home', title: translations[currentLang].home, icon: 'fa-home' },
      { id: 'events', title: translations[currentLang].events, icon: 'fa-calendar-alt' },
      { id: 'reviews', title: translations[currentLang].reviews, icon: 'fa-comment' },
      { id: 'routes', title: translations[currentLang].routes, icon: 'fa-bus' },
      { id: 'clinics', title: translations[currentLang].clinics, icon: 'fa-hospital' },
      { id: 'police', title: translations[currentLang].police, icon: 'fa-shield-haltered' }
    ];
    if (currentUser) {
      if (currentUser.role === 'akim') items.push({ id: 'akimat', title: translations[currentLang].akimat, icon: 'fa-landmark' });
      if (currentUser.role === 'ispolnitel') items.push({ id: 'executors', title: translations[currentLang].executors, icon: 'fa-hard-hat' });
      if (currentUser.role === 'citizen') items.push({ id: 'citizens', title: translations[currentLang].citizens, icon: 'fa-user-group' });
      items.push({ id: 'profile', title: translations[currentLang].profile, icon: 'fa-id-card' });
      items.push({ id: 'map', title: translations[currentLang].map, icon: 'fa-map' });
    } else {
      items.push({ id: 'map', title: translations[currentLang].map, icon: 'fa-map' });
    }
    items.forEach(item => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#'; a.className = 'nav-link'; a.dataset.section = item.id;
      a.innerHTML = `<i class="fas ${item.icon}"></i> ${item.title}`;
      a.onclick = e => { e.preventDefault(); switchSection(item.id); };
      li.appendChild(a); nav.appendChild(li);
    });
  }

  // ========== –†–ï–ù–î–ï–† –ë–õ–û–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =========
  async function renderAuthBlock() {
    const auth = document.getElementById('authBlock');
    if (!currentUser) {
      auth.innerHTML = `<button class="btn-outline btn" onclick="openModal('authModal')"><i class="fas fa-key"></i> ${translations[currentLang].login}</button>`;
      return;
    }
    const nots = await getNotifications();
    const unread = nots.filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).filter(n => !n.read).length;
    auth.innerHTML = `
      <div style="display:flex; align-items:center; gap:20px;">
        <div class="notification-bell" onclick="openNotificationsModal()">
          <i class="fas fa-bell" style="font-size:1.4rem;"></i>
          ${unread ? `<span class="notification-count">${unread}</span>` : ''}
        </div>
        <div class="user-bar">
          <div class="user-info">
            <span class="user-avatar">${currentUser.avatar}</span>
            <span class="user-name">${currentUser.name}</span>
          </div>
          <div class="balance-badge">
            <i class="fas fa-star"></i> ${currentUser.points || 0} ‚Ç∏
          </div>
          <button class="btn-outline btn-sm" onclick="logout()" title="${translations[currentLang].logout}">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    `;
  }

  // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ê–ó–î–ï–õ–û–í =========
  async function switchSection(sectionId) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    const active = Array.from(document.querySelectorAll('.nav-link')).find(l => l.dataset.section === sectionId);
    if (active) active.classList.add('active');

    if (!currentUser && ['akimat','executors','citizens','profile'].includes(sectionId)) sectionId = 'home';
    if (currentUser) {
      if (sectionId === 'akimat' && currentUser.role !== 'akim') sectionId = 'home';
      if (sectionId === 'executors' && currentUser.role !== 'ispolnitel') sectionId = 'home';
      if (sectionId === 'citizens' && currentUser.role !== 'citizen') sectionId = 'home';
    }
    const content = document.getElementById('dynamicContent');
    switch (sectionId) {
      case 'home': content.innerHTML = await renderHome(); break;
      case 'events': content.innerHTML = await renderEvents(); break;
      case 'profile': content.innerHTML = await renderProfile(); break;
      case 'akimat': content.innerHTML = await renderAkimat(); break;
      case 'executors': content.innerHTML = await renderExecutors(); break;
      case 'citizens': content.innerHTML = await renderCitizens(); break;
      case 'map': content.innerHTML = await renderMap(); setTimeout(() => initMap(), 200); break;
      case 'reviews': content.innerHTML = await renderReviewsPage(); break;
      case 'routes': content.innerHTML = await renderRoutesPage(); break;
      case 'clinics': content.innerHTML = await renderClinicsPage(); break;
      case 'police': content.innerHTML = await renderPolicePage(); break;
      default: content.innerHTML = await renderHome();
    }
  }

  // ---------- –ì–õ–ê–í–ù–ê–Ø ----------
  async function renderHome() {
    const reviews = await getReviews();
    return `<div class="section-header"><i class="fas fa-city"></i><h2>${currentLang === 'kz' ? '–°–µ–º–µ–π “õ–∞–ª–∞—Å—ã' : currentLang === 'en' ? 'Semey City' : '–ì–æ—Ä–æ–¥ –°–µ–º–µ–π'}</h2></div>
      <div class="grid-4">
        <div class="card stat-card" onclick="switchSection('clinics')">
          <div class="stat-number">9</div>
          <div style="font-size:1.1rem; font-weight:600;">${translations[currentLang].clinics}</div>
          <p style="color:#6c8fa0; margin-top:8px;">${currentLang === 'kz' ? '–ö”©—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑' : currentLang === 'en' ? 'Click to view' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'}</p>
        </div>
        <div class="card stat-card" onclick="switchSection('police')">
          <div class="stat-number">8</div>
          <div style="font-size:1.1rem; font-weight:600;">${translations[currentLang].police}</div>
          <p style="color:#6c8fa0; margin-top:8px;">${currentLang === 'kz' ? '–ö”©—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑' : currentLang === 'en' ? 'Click to view' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'}</p>
        </div>
        <div class="card stat-card" onclick="switchSection('routes')">
          <div class="stat-number">24</div>
          <div style="font-size:1.1rem; font-weight:600;">${translations[currentLang].routes}</div>
          <p style="color:#6c8fa0; margin-top:8px;">${currentLang === 'kz' ? '–ö”©—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑' : currentLang === 'en' ? 'Click to view' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'}</p>
        </div>
        <div class="card stat-card" onclick="switchSection('reviews')">
          <div class="stat-number">${reviews.length}</div>
          <div style="font-size:1.1rem; font-weight:600;">${translations[currentLang].reviews}</div>
          <p style="color:#6c8fa0; margin-top:8px;">${currentLang === 'kz' ? '–ö”©—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑' : currentLang === 'en' ? 'Click to view' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'}</p>
        </div>
      </div>
      <div class="grid-2" style="margin-top:28px;">
        <div class="card" onclick="switchSection('events')">
          <div class="card-title"><i class="fas fa-calendar-alt"></i> ${currentLang === 'kz' ? '–ñ–∞“õ—ã–Ω–¥–∞“ì—ã —ñ—Å-—à–∞—Ä–∞–ª–∞—Ä' : currentLang === 'en' ? 'Upcoming events' : '–ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è'}</div>
          <p>25.02 ‚Äî ${currentLang === 'kz' ? '¬´–î–∞–ª–∞ ”ô—É–µ–Ω–¥–µ—Ä—ñ¬ª –∫–æ–Ω—Ü–µ—Ä—Ç—ñ' : currentLang === 'en' ? 'Concert "Melodies of the Steppe"' : '–ö–æ–Ω—Ü–µ—Ä—Ç ¬´–ú–µ–ª–æ–¥–∏–∏ —Å—Ç–µ–ø–∏¬ª'}</p>
          <p>01.03 ‚Äî ${currentLang === 'kz' ? '–ñ–∞—Å —Å—É—Ä–µ—Ç—à—ñ–ª–µ—Ä –∫”©—Ä–º–µ—Å—ñ' : currentLang === 'en' ? 'Young artists exhibition' : '–í—ã—Å—Ç–∞–≤–∫–∞ –º–æ–ª–æ–¥—ã—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤'}</p>
          <p>05.03 ‚Äî ${currentLang === 'kz' ? '¬´–ñ–∞—Å—ã–ª –°–µ–º–µ–π¬ª –≤–µ–ª–æ–∂–∞—Ä—ã—Å—ã' : currentLang === 'en' ? 'Bike ride "Green Semey"' : '–í–µ–ª–æ–ø—Ä–æ–±–µ–≥ ¬´–ó–µ–ª–µ–Ω—ã–π –°–µ–º–µ–π¬ª'}</p>
          <span style="color:var(--egov-blue); margin-top:12px; display:block;">${currentLang === 'kz' ? '–ë–∞—Ä–ª—ã“õ —ñ—Å-—à–∞—Ä–∞–ª–∞—Ä ‚Üí' : currentLang === 'en' ? 'All events ‚Üí' : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π ‚Üí'}</span>
        </div>
        <div class="card" onclick="switchSection('map')">
          <div class="card-title"><i class="fas fa-map-marked-alt"></i> ${translations[currentLang].map}</div>
          <p>${currentLang === 'kz' ? '–ú”ô—Å–µ–ª–µ–ª–µ—Ä, “õ“±—Ä—ã–ª—ã—Å –∂–æ—Å–ø–∞—Ä–ª–∞—Ä—ã, –ø–æ–ª–∏—Ü–∏—è' : currentLang === 'en' ? 'Problems, construction plans, police' : '–ü—Ä–æ–±–ª–µ–º—ã, –ø–ª–∞–Ω—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –ø–æ–ª–∏—Ü–∏—è'}</p>
          <span style="color:var(--egov-blue); margin-top:12px; display:block;">${currentLang === 'kz' ? '–ö–∞—Ä—Ç–∞“ì–∞ ”©—Ç—É ‚Üí' : currentLang === 'en' ? 'Go to map ‚Üí' : '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ä—Ç–µ ‚Üí'}</span>
        </div>
      </div>`;
  }

  // ---------- –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ----------
  async function renderEvents() {
    const events = [
      { title: currentLang === 'kz' ? '¬´–î–∞–ª–∞ ”ô—É–µ–Ω–¥–µ—Ä—ñ¬ª –∫–æ–Ω—Ü–µ—Ä—Ç—ñ' : currentLang === 'en' ? 'Concert "Melodies of the Steppe"' : '–ö–æ–Ω—Ü–µ—Ä—Ç ¬´–ú–µ–ª–æ–¥–∏–∏ —Å—Ç–µ–ø–∏¬ª', date: "25 —Ñ–µ–≤—Ä–∞–ª—è 2026", place: currentLang === 'kz' ? '–î—Ä–∞–º—Ç–µ–∞—Ç—Ä' : currentLang === 'en' ? 'Drama Theater' : '–î—Ä–∞–º—Ç–µ–∞—Ç—Ä', image: "üéµ" },
      { title: currentLang === 'kz' ? '–ñ–∞—Å —Å—É—Ä–µ—Ç—à—ñ–ª–µ—Ä –∫”©—Ä–º–µ—Å—ñ' : currentLang === 'en' ? 'Young artists exhibition' : '–í—ã—Å—Ç–∞–≤–∫–∞ –º–æ–ª–æ–¥—ã—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤', date: "1-10 –º–∞—Ä—Ç–∞ 2026", place: currentLang === 'kz' ? '–û–±–ª—ã—Å—Ç—ã“õ –º—É–∑–µ–π' : currentLang === 'en' ? 'Regional Museum' : '–û–±–ª–∞—Å—Ç–Ω–æ–π –º—É–∑–µ–π', image: "üé®" },
      { title: currentLang === 'kz' ? '¬´–ñ–∞—Å—ã–ª –°–µ–º–µ–π¬ª –≤–µ–ª–æ–∂–∞—Ä—ã—Å—ã' : currentLang === 'en' ? 'Bike ride "Green Semey"' : '–í–µ–ª–æ–ø—Ä–æ–±–µ–≥ ¬´–ó–µ–ª–µ–Ω—ã–π –°–µ–º–µ–π¬ª', date: "5 –º–∞—Ä—Ç–∞ 2026", place: currentLang === 'kz' ? '–ñ–µ“£—ñ—Å –ø–∞—Ä–∫—ñ' : currentLang === 'en' ? 'Victory Park' : '–ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã', image: "üö¥" },
      { title: currentLang === 'kz' ? '“ö–∞–ª–∞ –∫“Ø–Ω—ñ' : currentLang === 'en' ? 'City Day' : '–î–µ–Ω—å –≥–æ—Ä–æ–¥–∞', date: "15 –∞–ø—Ä–µ–ª—è 2026", place: currentLang === 'kz' ? '–û—Ä—Ç–∞–ª—ã“õ –∞–ª–∞“£' : currentLang === 'en' ? 'Central Square' : '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', image: "üèõÔ∏è" },
      { title: currentLang === 'kz' ? '“ö–æ–ª”©–Ω–µ—Ä—à—ñ–ª–µ—Ä –∂”ô—Ä–º–µ“£–∫–µ—Å—ñ' : currentLang === 'en' ? 'Craftsmen Fair' : '–Ø—Ä–º–∞—Ä–∫–∞ —Ä–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–æ–≤', date: "20-22 –º–∞—Ä—Ç–∞ 2026", place: currentLang === 'kz' ? '–û—Ä—Ç–∞–ª—ã“õ —Å—Ç–∞–¥–∏–æ–Ω' : currentLang === 'en' ? 'Central Stadium' : '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω', image: "üß∂" },
      { title: currentLang === 'kz' ? '–ë–∞–ª–∞–ª–∞—Ä —Å–ø–µ–∫—Ç–∞–∫–ª—ñ' : currentLang === 'en' ? 'Children\'s performance' : '–î–µ—Ç—Å–∫–∏–π —Å–ø–µ–∫—Ç–∞–∫–ª—å', date: "12 –º–∞—Ä—Ç–∞ 2026", place: currentLang === 'kz' ? '“ö—É—ã—Ä—à–∞“õ —Ç–µ–∞—Ç—Ä—ã' : currentLang === 'en' ? 'Puppet Theater' : '–¢–µ–∞—Ç—Ä –∫—É–∫–æ–ª', image: "üß∏" }
    ];
    return `<div class="section-header"><i class="fas fa-calendar-alt"></i><h2>${currentLang === 'kz' ? '–°–µ–º–µ–π —ñ—Å-—à–∞—Ä–∞–ª–∞—Ä—ã' : currentLang === 'en' ? 'Semey Events' : '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –°–µ–º–µ—è'}</h2></div>
      <div class="grid-3">
        ${events.map(e => `
          <div class="event-card">
            <div class="event-image">${e.image}</div>
            <div class="event-info">
              <h3 style="font-size:1.2rem; margin-bottom:8px;">${e.title}</h3>
              <p style="color:#6c8fa0;"><i class="fas fa-calendar"></i> ${e.date}</p>
              <p style="color:#6c8fa0;"><i class="fas fa-map-marker-alt"></i> ${e.place}</p>
            </div>
          </div>
        `).join('')}
      </div>`;
  }

  // ---------- –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ----------
  async function renderProfile() {
    if (!currentUser) return '';
    const nots = (await getNotifications()).filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).slice(-5);
    return `<div class="section-header"><i class="fas fa-id-card"></i><h2>${translations[currentLang].profile}</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-user"></i> ${currentLang === 'kz' ? '–ú–µ–Ω—ñ“£ –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–º' : currentLang === 'en' ? 'My data' : '–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ'}</div>
          <ul style="list-style:none;">
            <li style="margin-bottom:10px;"><i class="fas fa-hashtag"></i> –ò–ò–ù: ${currentUser.iin}</li>
            <li style="margin-bottom:10px;"><i class="fas fa-user"></i> ${currentLang === 'kz' ? '–¢–ê”ò' : currentLang === 'en' ? 'Full name' : '–§–ò–û'}: ${currentUser.name}</li>
            <li style="margin-bottom:10px;"><i class="fas fa-tag"></i> ${currentLang === 'kz' ? '–†”©–ª—ñ' : currentLang === 'en' ? 'Role' : '–†–æ–ª—å'}: ${currentUser.role === 'akim' ? (currentLang === 'kz' ? '”ò–∫—ñ–º' : currentLang === 'en' ? 'Akim' : '–ê–∫–∏–º') : currentUser.role === 'ispolnitel' ? (currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å') : (currentLang === 'kz' ? '–¢“±—Ä“ì—ã–Ω' : currentLang === 'en' ? 'Citizen' : '–ñ–∏—Ç–µ–ª—å')}</li>
            <li style="margin-bottom:10px;"><i class="fas fa-star"></i> ${currentLang === 'kz' ? '–ë–∞–ª–ª –±–∞–ª–∞–Ω—Å—ã' : currentLang === 'en' ? 'Points balance' : '–ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤'}: <span id="userPoints">${currentUser.points || 0}</span> ‚Ç∏</li>
          </ul>
          ${currentUser.role === 'citizen' ? `<button class="btn" style="margin-top:20px;" onclick="openAppealModal()"><i class="fas fa-paper-plane"></i> ${currentLang === 'kz' ? '”ò–∫—ñ–º–≥–µ –∂–µ–∫–µ ”©—Ç—ñ–Ω—ñ—à' : currentLang === 'en' ? 'Personal appeal to the akim' : '–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∞–∫–∏–º—É'}</button>` : ''}
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-bell"></i> ${currentLang === 'kz' ? '–°–æ“£“ì—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä' : currentLang === 'en' ? 'Latest notifications' : '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}</div>
          ${nots.length ? nots.map(n => `<p style="border-bottom:1px solid #eee; padding:8px 0;">${n.text}</p>`).join('') : `<p>${currentLang === 'kz' ? '–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä –∂–æ“õ' : currentLang === 'en' ? 'No notifications' : '–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π'}</p>`}
        </div>
      </div>
      <div class="card" style="margin-top:28px; cursor:default;">
        <div class="card-title"><i class="fas fa-credit-card"></i> ${currentLang === 'kz' ? '–°–∞–ª—ã“õ—Ç–∞—Ä –º–µ–Ω —Ç”©–ª–µ–º–¥–µ—Ä' : currentLang === 'en' ? 'Taxes and payments' : '–ù–∞–ª–æ–≥–∏ –∏ –ø–ª–∞—Ç–µ–∂–∏'}</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
          <button class="btn" onclick="openPaymentModal('tax')"><i class="fas fa-file-invoice"></i> ${currentLang === 'kz' ? '–°–∞–ª—ã“õ —Ç”©–ª–µ—É' : currentLang === 'en' ? 'Pay taxes' : '–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤'}</button>
          <button class="btn" onclick="openPaymentModal('fine')"><i class="fas fa-exclamation-triangle"></i> ${currentLang === 'kz' ? '–ê–π—ã–ø–ø“±–ª —Ç”©–ª–µ—É' : currentLang === 'en' ? 'Pay fines' : '–û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–æ–≤'}</button>
          <button class="btn" onclick="openPaymentModal('utility')"><i class="fas fa-bolt"></i> ${currentLang === 'kz' ? '–ö–æ–º–º—É–Ω–∞–ª–¥—ã“õ “õ—ã–∑–º–µ—Ç—Ç–µ—Ä' : currentLang === 'en' ? 'Utility services' : '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏'}</button>
        </div>
        <p style="margin-top:16px; color:#004a7c;"><i class="fas fa-coins"></i> 1 –±–∞–ª–ª = 1 ‚Ç∏. ${currentLang === 'kz' ? '–°—ñ–∑ –±–∞–ª–ª–¥–∞—Ä—ã“£—ã–∑–±–µ–Ω –∫–µ–∑ –∫–µ–ª–≥–µ–Ω “õ—ã–∑–º–µ—Ç—Ç—ñ —Ç”©–ª–µ–π –∞–ª–∞—Å—ã–∑.' : currentLang === 'en' ? 'You can pay for any service with points.' : '–í—ã –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ –ª—é–±—É—é —É—Å–ª—É–≥—É.'}</p>
      </div>`;
  }

  // ---------- –ü–õ–ê–¢–Å–ñ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ----------
  window.openPaymentModal = function(type) {
    let html = `<div style="display:flex; justify-content:space-between;"><h3 style="color:#004a7c;">${currentLang === 'kz' ? '–¢”©–ª–µ–º' : currentLang === 'en' ? 'Payment' : '–û–ø–ª–∞—Ç–∞'}</h3><i class="fas fa-times" style="font-size:1.6rem; color:#6c8fa0; cursor:pointer;" onclick="closeModal('paymentModal')"></i></div>`;
    if (type === 'tax') {
      html += `<p>${currentLang === 'kz' ? '–°–∞–ª—ã“õ—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑:' : currentLang === 'en' ? 'Select tax:' : '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥:'}</p>
        <select id="paymentSelect" class="fake-input">
          <option value="25000">${currentLang === 'kz' ? '–ú“Ø–ª—ñ–∫ —Å–∞–ª—ã“ì—ã' : currentLang === 'en' ? 'Property tax' : '–ù–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ'} - 25 000 ‚Ç∏</option>
          <option value="15000">${currentLang === 'kz' ? '–ñ–µ—Ä —Å–∞–ª—ã“ì—ã' : currentLang === 'en' ? 'Land tax' : '–ó–µ–º–µ–ª—å–Ω—ã–π –Ω–∞–ª–æ–≥'} - 15 000 ‚Ç∏</option>
          <option value="8000">${currentLang === 'kz' ? '–ö”©–ª—ñ–∫ —Å–∞–ª—ã“ì—ã' : currentLang === 'en' ? 'Transport tax' : '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π –Ω–∞–ª–æ–≥'} - 8 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-id-card"></i><input id="taxIIN" placeholder="–ò–ò–ù" value="${currentUser?.iin || ''}"></div>`;
    } else if (type === 'fine') {
      html += `<p>${currentLang === 'kz' ? '–ê–π—ã–ø–ø“±–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:' : currentLang === 'en' ? 'Select fine:' : '–í—ã–±–µ—Ä–∏—Ç–µ —à—Ç—Ä–∞—Ñ:'}</p>
        <select id="paymentSelect" class="fake-input">
          <option value="5000">${currentLang === 'kz' ? '–ñ—ã–ª–¥–∞–º–¥—ã“õ—Ç—ã –∞—Å—ã—Ä—É' : currentLang === 'en' ? 'Speeding' : '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏'} - 5 000 ‚Ç∏</option>
          <option value="10000">${currentLang === 'kz' ? '–î“±—Ä—ã—Å –µ–º–µ—Å —Ç“±—Ä–∞“õ' : currentLang === 'en' ? 'Wrong parking' : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞'} - 10 000 ‚Ç∏</option>
          <option value="15000">${currentLang === 'kz' ? '“ö—ã–∑—ã–ª“ì–∞ ”©—Ç—É' : currentLang === 'en' ? 'Running a red light' : '–ü—Ä–æ–µ–∑–¥ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π'} - 15 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-car"></i><input id="carNumber" placeholder="${currentLang === 'kz' ? '–ê–≤—Ç–æ–∫”©–ª—ñ–∫ –Ω”©–º—ñ—Ä—ñ' : currentLang === 'en' ? 'Car number' : '–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è'}"></div>`;
    } else if (type === 'utility') {
      html += `<p>${currentLang === 'kz' ? '“ö—ã–∑–º–µ—Ç—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑:' : currentLang === 'en' ? 'Select service:' : '–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:'}</p>
        <select id="paymentSelect" class="fake-input">
          <option value="8000">${currentLang === 'kz' ? '–≠–ª–µ–∫—Ç—Ä —ç–Ω–µ—Ä–≥–∏—è—Å—ã' : currentLang === 'en' ? 'Electricity' : '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ'} - 8 000 ‚Ç∏</option>
          <option value="4500">${currentLang === 'kz' ? '–°—É' : currentLang === 'en' ? 'Water' : '–í–æ–¥–∞'} - 4 500 ‚Ç∏</option>
          <option value="6000">${currentLang === 'kz' ? '–ì–∞–∑' : currentLang === 'en' ? 'Gas' : '–ì–∞–∑'} - 6 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-id-card"></i><input id="utilityIIN" placeholder="–ò–ò–ù" value="${currentUser?.iin || ''}"></div>
        <div class="fake-input"><i class="fas fa-map-marker-alt"></i><input id="utilityAddress" placeholder="${currentLang === 'kz' ? '–ú–µ–∫–µ–Ω–∂–∞–π, –ø”ô—Ç–µ—Ä' : currentLang === 'en' ? 'Address, apartment' : '–ê–¥—Ä–µ—Å, –∫–≤–∞—Ä—Ç–∏—Ä–∞'}"></div>`;
    }
    html += `<p style="margin-top:20px;">${currentLang === 'kz' ? '–°–æ–º–∞' : currentLang === 'en' ? 'Amount' : '–°—É–º–º–∞'}: <span id="paymentAmount">0</span> ‚Ç∏</p>
      <button class="btn" onclick="calculatePayment()">${currentLang === 'kz' ? '–ï—Å–µ–ø—Ç–µ—É' : currentLang === 'en' ? 'Calculate' : '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å'}</button>
      <div id="paymentMethods" style="margin-top:20px; display:none;">
        <p>${currentLang === 'kz' ? '–¢”©–ª–µ–º —Ç”ô—Å—ñ–ª—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑:' : currentLang === 'en' ? 'Select payment method:' : '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:'}</p>
        <button class="btn-outline" onclick="payWithCard()">üí≥ ${currentLang === 'kz' ? '–ë–∞–Ω–∫ –∫–∞—Ä—Ç–∞—Å—ã' : currentLang === 'en' ? 'Bank card' : '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞'}</button>
        <button class="btn-outline" onclick="payWithPoints()">‚≠ê ${currentLang === 'kz' ? '–ë–∞–ª–ª–¥–∞—Ä–º–µ–Ω —Ç”©–ª–µ—É' : currentLang === 'en' ? 'Pay with points' : '–û–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏'}</button>
        <button class="btn-outline" onclick="payWithKaspi()">üíö Kaspi.kz</button>
        <button class="btn-outline" onclick="payWithHalyk()">üè¶ Halyk Bank</button>
        <button class="btn-outline" onclick="payWithApplePay()">üçè Apple Pay</button>
      </div>`;
    const modal = document.getElementById('paymentModal');
    modal.querySelector('#paymentContent').innerHTML = html;
    openModal('paymentModal');
  };
  
  window.calculatePayment = function() {
    const select = document.getElementById('paymentSelect');
    const amount = parseInt(select.value, 10);
    document.getElementById('paymentAmount').innerText = amount;
    document.getElementById('paymentMethods').style.display = 'block';
  };
  
  window.payWithPoints = async function() {
    const amount = parseInt(document.getElementById('paymentAmount').innerText, 10);
    const pointsNeeded = amount;
    if ((currentUser.points || 0) < pointsNeeded) {
      alert(`${currentLang === 'kz' ? '–ë–∞–ª–ª–¥–∞—Ä –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑. “ö–∞–∂–µ—Ç:' : currentLang === 'en' ? 'Insufficient points. Required:' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è:'} ${pointsNeeded}, ${currentLang === 'kz' ? '—Å—ñ–∑–¥–µ:' : currentLang === 'en' ? 'you have:' : '—É –≤–∞—Å:'} ${currentUser.points || 0}`);
      return;
    }
    let users = await getUsers();
    let user = users.find(u => u.iin === currentUser.iin);
    if (user) {
      user.points = (user.points || 0) - pointsNeeded;
      currentUser.points = user.points;
      await saveUsers(users);
      alert(`${currentLang === 'kz' ? '–¢”©–ª–µ–º —Å”ô—Ç—Ç—ñ ”©—Ç—Ç—ñ!' : currentLang === 'en' ? 'Payment successful!' : '–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!'} ${currentLang === 'kz' ? '–ï—Å–µ–ø—Ç–µ–Ω —à—ã“ì–∞—Ä—ã–ª–¥—ã' : currentLang === 'en' ? 'Debited' : '–°–ø–∏—Å–∞–Ω–æ'} ${pointsNeeded} ${currentLang === 'kz' ? '–±–∞–ª–ª' : currentLang === 'en' ? 'points' : '–±–∞–ª–ª–æ–≤'}.`);
      closeModal('paymentModal');
      const pointsSpan = document.getElementById('userPoints');
      if (pointsSpan) pointsSpan.innerText = user.points;
      renderAuthBlock();
    }
  };
  
  window.payWithCard = function() { 
    alert(currentLang === 'kz' ? '–ö–∞—Ä—Ç–∞ —Ç”©–ª–µ–º —à–ª—é–∑—ñ–Ω–µ ”©—Ç—É...' : currentLang === 'en' ? 'Redirecting to card payment gateway...' : '–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑ –¥–ª—è –∫–∞—Ä—Ç—ã...'); 
    closeModal('paymentModal'); 
  };
  
  window.payWithKaspi = function() { 
    alert(currentLang === 'kz' ? 'Kaspi.kz-–∫–µ ”©—Ç—É...' : currentLang === 'en' ? 'Redirecting to Kaspi.kz...' : '–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Kaspi.kz...'); 
    closeModal('paymentModal'); 
  };
  
  window.payWithHalyk = function() { 
    alert(currentLang === 'kz' ? 'Halyk Bank-–∫–µ ”©—Ç—É...' : currentLang === 'en' ? 'Redirecting to Halyk Bank...' : '–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Halyk Bank...'); 
    closeModal('paymentModal'); 
  };
  
  window.payWithApplePay = function() { 
    alert(currentLang === 'kz' ? 'Apple Pay-–≥–µ ”©—Ç—É...' : currentLang === 'en' ? 'Redirecting to Apple Pay...' : '–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Apple Pay...'); 
    closeModal('paymentModal'); 
  };

  // ---------- –°–¢–†–ê–ù–ò–¶–´ ----------
  async function renderReviewsPage() {
    const reviews = await getReviews();
    return `<div class="section-header"><i class="fas fa-comment"></i><h2>${currentLang === 'kz' ? '–ë–∞—Ä–ª—ã“õ –ø—ñ–∫—ñ—Ä–ª–µ—Ä' : currentLang === 'en' ? 'All reviews' : '–í—Å–µ –æ—Ç–∑—ã–≤—ã'}</h2></div>
      <div class="grid-3">${reviews.map(r => `<div class="card" style="cursor:default;">
        <p><strong>${r.userName}</strong> <span class="badge">‚≠ê ${r.rating} | üèÖ ${r.points}</span></p>
        <p>${r.text}</p>
        ${r.address ? `<p><i class="fas fa-map-marker-alt"></i> ${r.address}</p>` : ''}
        ${r.responses && r.responses.length ? `<div style="margin-top:12px; padding-left:12px; border-left:3px solid var(--egov-gold);">
          ${r.responses.map(resp => `<p><small><strong>${resp.from} (${resp.role === 'akim' ? (currentLang === 'kz' ? '”ò–∫—ñ–º' : currentLang === 'en' ? 'Akim' : '–ê–∫–∏–º') : resp.role === 'ispolnitel' ? (currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å') : (currentLang === 'kz' ? '–¢“±—Ä“ì—ã–Ω' : currentLang === 'en' ? 'Citizen' : '–ñ–∏—Ç–µ–ª—å')})</strong> ${resp.date}</small><br>${resp.text}</p>`).join('')}
        </div>` : ''}
      </div>`).join('')}</div>`;
  }

  async function renderRoutesPage() {
    const routes = [
      { num: 1, name: currentLang === 'kz' ? '–í–æ—Å—Ö–æ–¥ ‚Äì –û—Ä—Ç–∞–ª—ã“õ' : currentLang === 'en' ? 'Voskhod ‚Äì Center' : '–í–æ—Å—Ö–æ–¥ ‚Äì –¶–µ–Ω—Ç—Ä', interval: "10 –º–∏–Ω" },
      { num: 2, name: currentLang === 'kz' ? '–î–∞—á–Ω—ã–π ‚Äì ”ò—É–µ–∂–∞–π' : currentLang === 'en' ? 'Dachny ‚Äì Airport' : '–î–∞—á–Ω—ã–π ‚Äì –ê—ç—Ä–æ–ø–æ—Ä—Ç', interval: "15 –º–∏–Ω" },
      { num: 3, name: currentLang === 'kz' ? '–ñ–∞“£–∞-–°–µ–º–µ–π ‚Äì –¢–µ–º—ñ—Ä–∂–æ–ª –≤–æ–∫–∑–∞–ª—ã' : currentLang === 'en' ? 'Zhana-Semey ‚Äì Railway station' : '–ñ–∞–Ω–∞-–°–µ–º–µ–π ‚Äì –ñ/–¥ –≤–æ–∫–∑–∞–ª', interval: "12 –º–∏–Ω" },
      { num: 4, name: currentLang === 'kz' ? '–ö–•–¢–ò ‚Äì –®”ô–∫”ô—Ä—ñ–º –¥–∞“£“ì—ã–ª—ã' : currentLang === 'en' ? 'KHTI ‚Äì Shakarim Ave' : '–ö–•–¢–ò ‚Äì –®–∞–∫–∞—Ä–∏–º–∞', interval: "20 –º–∏–Ω" },
      { num: 5, name: currentLang === 'kz' ? '–ë–æ–±—Ä–æ–≤–æ —à–∞“ì—ã–Ω –∞—É–¥–∞–Ω—ã ‚Äì –î—Ä–∞–º—Ç–µ–∞—Ç—Ä' : currentLang === 'en' ? 'Bobrovo district ‚Äì Drama Theater' : '–º–∫—Ä. –ë–æ–±—Ä–æ–≤–æ ‚Äì –î—Ä–∞–º—Ç–µ–∞—Ç—Ä', interval: "18 –º–∏–Ω" },
      { num: 6, name: currentLang === 'kz' ? '–¶–µ–º–µ–Ω—Ç –∑–∞—É—ã—Ç—ã ‚Äì –®—ã“ì—ã—Å –∫–µ–Ω—Ç—ñ' : currentLang === 'en' ? 'Cement plant ‚Äì Vostochny settlement' : '–¶–µ–º–µ–Ω—Ç–Ω—ã–π –∑–∞–≤–æ–¥ ‚Äì –ø–æ—Å. –í–æ—Å—Ç–æ—á–Ω—ã–π', interval: "25 –º–∏–Ω" },
      { num: 7, name: currentLang === 'kz' ? '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ‚Äì –ö–æ–∂–∑–∞–≤–æ–¥' : currentLang === 'en' ? 'Bus station ‚Äì Kozhzavod' : '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ‚Äì –ö–æ–∂–∑–∞–≤–æ–¥', interval: "17 –º–∏–Ω" },
      { num: 8, name: currentLang === 'kz' ? '–ì–∞–≥–∞—Ä–∏–Ω –∫-—Å—ñ ‚Äì “ö–∞—Ä–∞“ì–∞–π–ª—ã —à–∞“ì—ã–Ω –∞—É–¥–∞–Ω—ã' : currentLang === 'en' ? 'Gagarin str. ‚Äì Karagaily district' : '—É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞ ‚Äì –º–∫—Ä. –ö–∞—Ä–∞–≥–∞–π–ª—ã', interval: "14 –º–∏–Ω" },
      { num: 9, name: currentLang === 'kz' ? '”ò—É–µ–∑–æ–≤ –¥–∞“£“ì—ã–ª—ã ‚Äì –®”ô–∫”ô—Ä—ñ–º –∞—Ç—ã–Ω–¥–∞“ì—ã –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç' : currentLang === 'en' ? 'Auezov Ave ‚Äì Shakarim University' : '–ø—Ä. –ê—É—ç–∑–æ–≤–∞ ‚Äì –ö–ì–£ –∏–º. –®–∞–∫–∞—Ä–∏–º–∞', interval: "12 –º–∏–Ω" },
      { num: 10, name: currentLang === 'kz' ? '–°–∏–ª–∏–∫–∞—Ç–Ω—ã–π ‚Äì –û—Ä—Ç–∞–ª—ã“õ –±–∞–∑–∞—Ä' : currentLang === 'en' ? 'Silikatny ‚Äì Central Market' : '–°–∏–ª–∏–∫–∞—Ç–Ω—ã–π ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫', interval: "22 –º–∏–Ω" }
    ];
    return `<div class="section-header"><i class="fas fa-bus"></i><h2>${currentLang === 'kz' ? '–°–µ–º–µ–π –±–∞“ì—ã—Ç—Ç–∞—Ä—ã' : currentLang === 'en' ? 'Semey Routes' : '–ú–∞—Ä—à—Ä—É—Ç—ã –°–µ–º–µ—è'}</h2></div><div class="grid-4">${routes.map(r => `<div class="card" style="cursor:default;"><h3>üöå ‚Ññ${r.num}</h3><p>${r.name}</p><p><i class="fas fa-clock"></i> ${r.interval}</p></div>`).join('')}</div>`;
  }

  async function renderClinicsPage() {
    const clinics = [
      { name: currentLang === 'kz' ? '‚Ññ1 “õ–∞–ª–∞–ª—ã“õ –µ–º—Ö–∞–Ω–∞' : currentLang === 'en' ? 'City Polyclinic ‚Ññ1' : '–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ1', address: currentLang === 'kz' ? '”ò—É–µ–∑–æ–≤ –∫-—Å—ñ, 12' : currentLang === 'en' ? 'Auezov str., 12' : '—É–ª. –ê—É—ç–∑–æ–≤–∞, 12', phone: "8 (7222) 56-78-90", hours: "08:00‚Äì20:00" },
      { name: currentLang === 'kz' ? '‚Ññ3 –±–∞–ª–∞–ª–∞—Ä –µ–º—Ö–∞–Ω–∞—Å—ã' : currentLang === 'en' ? 'Children\'s Polyclinic ‚Ññ3' : '–î–µ—Ç—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ3', address: currentLang === 'kz' ? '“ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä –∫-—Å—ñ, 45' : currentLang === 'en' ? 'Kabanbay batyr str., 45' : '—É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞, 45', phone: "8 (7222) 33-22-11", hours: "08:00‚Äì18:00" },
      { name: currentLang === 'kz' ? '‚Ññ4 –µ—Ä–µ—Å–µ–∫—Ç–µ—Ä –µ–º—Ö–∞–Ω–∞—Å—ã' : currentLang === 'en' ? 'Adult Polyclinic ‚Ññ4' : '–í–∑—Ä–æ—Å–ª–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ4', address: currentLang === 'kz' ? '–®”ô–∫”ô—Ä—ñ–º –¥–∞“£“ì—ã–ª—ã, 101' : currentLang === 'en' ? 'Shakarim Ave, 101' : '–ø—Ä. –®–∞–∫–∞—Ä–∏–º–∞, 101', phone: "8 (7222) 44-55-66", hours: "08:00‚Äì20:00" }
    ];
    return `<div class="section-header"><i class="fas fa-hospital"></i><h2>${translations[currentLang].clinics}</h2></div><div class="grid-3">${clinics.map(c => `<div class="card" style="cursor:default;"><h3>üè• ${c.name}</h3><p>üìç ${c.address}</p><p>üìû ${c.phone}</p><p>üïí ${c.hours}</p></div>`).join('')}</div>`;
  }

  function getPoliceStations() {
    return [
      { id: 1, name: currentLang === 'kz' ? '–°–µ–º–µ–π “õ–∞–ª–∞—Å—ã–Ω—ã“£ –ø–æ–ª–∏—Ü–∏—è –±–∞—Å“õ–∞—Ä–º–∞—Å—ã' : currentLang === 'en' ? 'Semey City Police Department' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ü–∏–∏ –≥. –°–µ–º–µ–π', address: currentLang === 'kz' ? '–®—É–≥–∞–µ–≤ –∫-—Å—ñ, 62' : currentLang === 'en' ? 'Shugaev str., 62' : '—É–ª. –®—É–≥–∞–µ–≤–∞, 62', phone: "8 (7222) 52-40-01", lat: 50.421, lng: 80.245 },
      { id: 2, name: currentLang === 'kz' ? '‚Ññ1 –ø–æ–ª–∏—Ü–∏—è –±”©–ª—ñ–º—ñ (–û—Ä—Ç–∞–ª—ã“õ)' : currentLang === 'en' ? 'Police Department ‚Ññ1 (Central)' : '–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ1 (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)', address: currentLang === 'kz' ? '–î—É–ª–∞—Ç–æ–≤ –∫-—Å—ñ, 12' : currentLang === 'en' ? 'Dulatov str., 12' : '—É–ª. –î—É–ª–∞—Ç–æ–≤–∞, 12', phone: "8 (7222) 56-30-20", lat: 50.411, lng: 80.237 },
      { id: 3, name: currentLang === 'kz' ? '‚Ññ2 –ø–æ–ª–∏—Ü–∏—è –±”©–ª—ñ–º—ñ (–¢–µ–º—ñ—Ä–∂–æ–ª)' : currentLang === 'en' ? 'Police Department ‚Ññ2 (Railway)' : '–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ2 (–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π)', address: currentLang === 'kz' ? '–ì–∞–≥–∞—Ä–∏–Ω –∫-—Å—ñ, 80' : currentLang === 'en' ? 'Gagarin str., 80' : '—É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, 80', phone: "8 (7222) 33-40-50", lat: 50.400, lng: 80.220 }
    ];
  }
  
  async function renderPolicePage() {
    setTimeout(() => initPoliceMap(), 200);
    const stations = getPoliceStations();
    return `<div class="section-header"><i class="fas fa-shield-haltered"></i><h2>${translations[currentLang].police}</h2></div>
      <div id="policeMapContainer" class="map-container" style="height:400px;"></div>
      <div class="grid-3" style="margin-top:28px;">${stations.map(s => `<div class="card" style="cursor:default;"><h3><i class="fas fa-shield" style="color:#d32f2f;"></i> ${s.name}</h3><p>üìç ${s.address}</p><p>üìû ${s.phone}</p></div>`).join('')}</div>`;
  }
  
  function initPoliceMap() {
    if (!document.getElementById('policeMapContainer')) return;
    const policeMap = L.map('policeMapContainer').setView([50.411, 80.227], 12);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' }).addTo(policeMap);
    getPoliceStations().forEach(s => {
      const marker = L.marker([s.lat, s.lng], { icon: getMarkerIcon('police') }).addTo(policeMap);
      marker.bindPopup(`<b>${s.name}</b><br>${s.address}<br>üìû ${s.phone}`);
    });
  }

  // ---------- –ê–ö–ò–ú–ê–¢, –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò, –ñ–ò–¢–ï–õ–ò ----------
  async function renderAkimat() {
    const employees = await getEmployees();
    return `<div class="section-header"><i class="fas fa-landmark"></i><h2>${currentLang === 'kz' ? '”ò–∫—ñ–º –ø–∞–Ω–µ–ª—ñ' : currentLang === 'en' ? 'Akim Panel' : '–ü–∞–Ω–µ–ª—å –∞–∫–∏–º–∞'}</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-users"></i> ${currentLang === 'kz' ? '“ö—ã–∑–º–µ—Ç–∫–µ—Ä–ª–µ—Ä–¥—ñ –±–∞—Å“õ–∞—Ä—É' : currentLang === 'en' ? 'Employee Management' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏'}</div>
          <div style="max-height:300px; overflow-y:auto;">
            ${employees.filter(e => e.status === 'active').map(e => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                <div><strong>${e.name}</strong><br><small>${e.position} ¬∑ ${currentLang === 'kz' ? '–†–µ–π—Ç–∏–Ω–≥' : currentLang === 'en' ? 'Rating' : '–†–µ–π—Ç–∏–Ω–≥'}: ${e.rating || '‚Äî'}</small></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn-outline btn-sm" onclick="promoteEmployee(${e.id})"><i class="fas fa-arrow-up"></i> ${currentLang === 'kz' ? '–ñ–æ“ì–∞—Ä—ã–ª–∞—Ç—É' : currentLang === 'en' ? 'Promote' : '–ü–æ–≤—ã—Å–∏—Ç—å'}</button>
                  <button class="btn-outline btn-sm" onclick="demoteEmployee(${e.id})"><i class="fas fa-arrow-down"></i> ${currentLang === 'kz' ? '–¢”©–º–µ–Ω–¥–µ—Ç—É' : currentLang === 'en' ? 'Demote' : '–ü–æ–Ω–∏–∑–∏—Ç—å'}</button>
                  <button class="btn-outline btn-sm" style="border-color:#a00; color:#a00;" onclick="fireEmployee(${e.id})"><i class="fas fa-user-minus"></i> ${currentLang === 'kz' ? '–ñ“±–º—ã—Å—Ç–∞–Ω —à—ã“ì–∞—Ä—É' : currentLang === 'en' ? 'Fire' : '–£–≤–æ–ª–∏—Ç—å'}</button>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="btn" style="margin-top:20px;" onclick="addEmployee()"><i class="fas fa-user-plus"></i> ${currentLang === 'kz' ? '–ñ–∞“£–∞ “õ—ã–∑–º–µ—Ç–∫–µ—Ä —Ç–∞“ì–∞–π—ã–Ω–¥–∞—É' : currentLang === 'en' ? 'Appoint new employee' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–æ–≤–æ–≥–æ'}</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-bullhorn"></i> ${currentLang === 'kz' ? '–ñ–∞–ª–ø—ã ”©—Ç—ñ–Ω—ñ—à' : currentLang === 'en' ? 'General appeal' : '–û–±—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ'}</div>
          <textarea id="akimMessage" rows="3" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="${currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à –º”ô—Ç—ñ–Ω—ñ...' : currentLang === 'en' ? 'Appeal text...' : '–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è...'}"></textarea>
          <button class="btn" onclick="sendAkimNotification()"><i class="fas fa-paper-plane"></i> ${currentLang === 'kz' ? '–ë–∞—Ä–ª—ã“õ —Ç“±—Ä“ì—ã–Ω–¥–∞—Ä“ì–∞ –∂—ñ–±–µ—Ä—É' : currentLang === 'en' ? 'Send to all citizens' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –∂–∏—Ç–µ–ª—è–º'}</button>
        </div>
      </div>`;
  }
  
  window.promoteEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { 
      emp.position = emp.position.includes('–ë—Ä–∏–≥–∞–¥–∏—Ä') ? (currentLang === 'kz' ? '–ê“ì–∞ –±—Ä–∏–≥–∞–¥–∏—Ä' : currentLang === 'en' ? 'Senior foreman' : '–°—Ç–∞—Ä—à–∏–π –±—Ä–∏–≥–∞–¥–∏—Ä') : (currentLang === 'kz' ? '–ë—Ä–∏–≥–∞–¥–∏—Ä' : currentLang === 'en' ? 'Foreman' : '–ë—Ä–∏–≥–∞–¥–∏—Ä'); 
      await saveEmployees(emps); 
      switchSection('akimat'); 
    }
  };
  
  window.demoteEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { 
      emp.position = emp.position.includes('–†–∞–±–æ—á–∏–π') ? (currentLang === 'kz' ? '–°—Ç–∞–∂–µ—Ä' : currentLang === 'en' ? 'Intern' : '–°—Ç–∞–∂—ë—Ä') : (currentLang === 'kz' ? '–ñ“±–º—ã—Å—à—ã' : currentLang === 'en' ? 'Worker' : '–†–∞–±–æ—á–∏–π'); 
      await saveEmployees(emps); 
      switchSection('akimat'); 
    }
  };
  
  window.fireEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { 
      emp.status = 'inactive'; 
      await saveEmployees(emps); 
      switchSection('akimat'); 
    }
  };
  
  window.addEmployee = async function() {
    let name = prompt(currentLang === 'kz' ? '–ñ–∞“£–∞ “õ—ã–∑–º–µ—Ç–∫–µ—Ä–¥—ñ“£ –¢–ê”ò –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:' : currentLang === 'en' ? 'Enter the full name of the new employee:' : '–í–≤–µ–¥–∏—Ç–µ –§–ò–û –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:');
    if (!name) return;
    let emps = await getEmployees();
    let newId = emps.length ? Math.max(...emps.map(e=>e.id)) + 1 : 1;
    emps.push({ id: newId, name, position: currentLang === 'kz' ? '–°—Ç–∞–∂–µ—Ä' : currentLang === 'en' ? 'Intern' : '–°—Ç–∞–∂—ë—Ä', status: "active", rating: 3.0 });
    await saveEmployees(emps);
    switchSection('akimat');
  };
  
  window.sendAkimNotification = async function() {
    let msg = document.getElementById('akimMessage')?.value.trim();
    if (!msg) return alert(currentLang === 'kz' ? '–ú”ô—Ç—ñ–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter the text' : '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `${currentLang === 'kz' ? '”ò–∫—ñ–º' : currentLang === 'en' ? 'Akim' : '–ê–∫–∏–º'} ${currentUser.name}`, to: 'citizen', role: 'citizen', text: msg, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert(currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à –±–∞—Ä–ª—ã“õ —Ç“±—Ä“ì—ã–Ω–¥–∞—Ä“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!' : currentLang === 'en' ? 'The appeal has been sent to all citizens!' : '–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –∂–∏—Ç–µ–ª—è–º!');
    document.getElementById('akimMessage').value = '';
  };

  async function renderExecutors() {
    return `<div class="section-header"><i class="fas fa-hard-hat"></i><h2>${currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã –ø–∞–Ω–µ–ª—ñ' : currentLang === 'en' ? 'Executor Panel' : '–ü–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è'}</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-comment-dots"></i> ${currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à–∫–µ –∂–∞—É–∞–ø –±–µ—Ä—É' : currentLang === 'en' ? 'Respond to request' : '–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞—è–≤–∫—É'}</div>
          <select id="reviewSelect" class="fake-input" style="width:100%; margin-bottom:16px;">
            <option value="">${currentLang === 'kz' ? '-- ”®—Ç—ñ–Ω—ñ—à—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑ --' : currentLang === 'en' ? '-- Select a request --' : '-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É --'}</option>
            ${(await getReviews()).filter(r => r.status === 'active').map(r => `<option value="${r.id}">${r.userName}: ${r.text.substring(0,30)}</option>`).join('')}
          </select>
          <textarea id="executorResponse" rows="2" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="${currentLang === 'kz' ? '–ñ–∞—É–∞–ø –º”ô—Ç—ñ–Ω—ñ...' : currentLang === 'en' ? 'Response text...' : '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞...'}"></textarea>
          <button class="btn" onclick="sendExecutorResponse()"><i class="fas fa-reply"></i> ${currentLang === 'kz' ? '–ñ–∞—É–∞–ø –∂—ñ–±–µ—Ä—É' : currentLang === 'en' ? 'Send response' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç'}</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-user-tie"></i> ${currentLang === 'kz' ? '”ò–∫—ñ–º–≥–µ ”©—Ç—ñ–Ω—ñ—à' : currentLang === 'en' ? 'Appeal to the akim' : '–û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∞–∫–∏–º—É'}</div>
          <textarea id="executorToAkim" rows="3" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="${currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à –º”ô—Ç—ñ–Ω—ñ...' : currentLang === 'en' ? 'Appeal text...' : '–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è...'}"></textarea>
          <button class="btn" onclick="sendToAkim()"><i class="fas fa-paper-plane"></i> ${currentLang === 'kz' ? '”ò–∫—ñ–º–≥–µ –∂—ñ–±–µ—Ä—É' : currentLang === 'en' ? 'Send to akim' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–∫–∏–º—É'}</button>
        </div>
      </div>`;
  }
  
  window.sendExecutorResponse = async function() {
    const id = document.getElementById('reviewSelect')?.value;
    const text = document.getElementById('executorResponse')?.value.trim();
    if (!id || !text) return alert(currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑ –∂”ô–Ω–µ –∂–∞—É–∞–ø –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Select a request and enter a response' : '–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É –∏ –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç');
    const review = (await getReviews()).find(r => r.id == id);
    if (!review) return;
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `${currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'} ${currentUser.name}`, to: 'user', userIin: review.userId, text: `${currentLang === 'kz' ? '–°—ñ–∑–¥—ñ“£ –ø—ñ–∫—ñ—Ä—ñ“£—ñ–∑–≥–µ –∂–∞—É–∞–ø' : currentLang === 'en' ? 'Response to your review' : '–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –æ—Ç–∑—ã–≤'}: ${text}`, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert(currentLang === 'kz' ? '–ñ–∞—É–∞–ø —Ç“±—Ä“ì—ã–Ω“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!' : currentLang === 'en' ? 'Response sent to citizen!' : '–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∂–∏—Ç–µ–ª—é!');
  };
  
  window.sendToAkim = async function() {
    const text = document.getElementById('executorToAkim')?.value.trim();
    if (!text) return alert(currentLang === 'kz' ? '–ú”ô—Ç—ñ–Ω–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑' : currentLang === 'en' ? 'Enter the text' : '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `${currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã' : currentLang === 'en' ? 'Executor' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'} ${currentUser.name}`, to: 'role', role: 'akim', text: `${currentLang === 'kz' ? '–û—Ä—ã–Ω–¥–∞—É—à—ã–¥–∞–Ω ”©—Ç—ñ–Ω—ñ—à' : currentLang === 'en' ? 'Appeal from executor' : '–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è'}: ${text}`, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert(currentLang === 'kz' ? '”®—Ç—ñ–Ω—ñ—à ”ô–∫—ñ–º–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!' : currentLang === 'en' ? 'Appeal sent to akim!' : '–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–∫–∏–º—É!');
    document.getElementById('executorToAkim').value = '';
  };

  async function renderCitizens() {
    return `<div class="section-header"><i class="fas fa-user-group"></i><h2>${currentLang === 'kz' ? '–¢“±—Ä“ì—ã–Ω –ø–æ—Ä—Ç–∞–ª—ã' : currentLang === 'en' ? 'Citizen Portal' : '–ü–æ—Ä—Ç–∞–ª –∂–∏—Ç–µ–ª—è'}</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-map-marked-alt"></i> ${currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä “õ–∞–ª–¥—ã—Ä—É' : currentLang === 'en' ? 'Leave a review' : '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤'}</div>
          <button class="btn" onclick="openReviewModal()"><i class="fas fa-plus-circle"></i> ${currentLang === 'kz' ? '–ü—ñ–∫—ñ—Ä “õ–æ—Å—É' : currentLang === 'en' ? 'Add review' : '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤'}</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-clock"></i> ${currentLang === 'kz' ? '–ú–µ–Ω—ñ“£ ”©—Ç—ñ–Ω—ñ—à—Ç–µ—Ä—ñ–º' : currentLang === 'en' ? 'My requests' : '–ú–æ–∏ –∑–∞—è–≤–∫–∏'}</div>
          ${(await getReviews()).filter(r => r.userId === currentUser.iin).map(r => `
            <div style="border-bottom:1px solid #eee; padding:12px 0;">
              <p><strong>${r.text}</strong> <span class="badge">‚≠ê ${r.rating} | üèÖ ${r.points}</span></p>
              <small>${currentLang === 'kz' ? '–ú”ô—Ä—Ç–µ–±–µ' : currentLang === 'en' ? 'Status' : '–°—Ç–∞—Ç—É—Å'}: ${r.status}</small>
            </div>`).join('') || `<p>${currentLang === 'kz' ? '–°—ñ–∑–¥–µ ”ô–∑—ñ—Ä–≥–µ ”©—Ç—ñ–Ω—ñ—à—Ç–µ—Ä –∂–æ“õ.' : currentLang === 'en' ? 'You have no requests yet.' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫.'}</p>`}
        </div>
      </div>`;
  }

  // ---------- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ----------
  window.openNotificationsModal = async function() {
    let nots = await getNotifications();
    nots = nots.filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).sort((a,b) => b.id - a.id);
    let html = `<div style="display:flex; justify-content:space-between;"><h3 style="color:#004a7c;">${currentLang === 'kz' ? '–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä' : currentLang === 'en' ? 'Notifications' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}</h3><i class="fas fa-times" style="font-size:1.6rem; color:#6c8fa0; cursor:pointer;" onclick="closeModal('notificationsModal')"></i></div>`;
    if (!nots.length) html += `<p>${currentLang === 'kz' ? '–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä –∂–æ“õ' : currentLang === 'en' ? 'No notifications' : '–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π'}</p>`;
    else {
      nots.forEach(n => {
        html += `<div style="padding:16px; background:${n.read ? '#f5faff' : '#fffbe6'}; border-radius:16px; margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between;"><strong>${n.from}</strong> <span style="color:#6c8fa0;">${n.date}</span></div>
          <p style="margin-top:8px;">${n.text}</p>
          ${!n.read ? `<button class="btn-outline btn-sm" style="margin-top:8px;" onclick="markNotificationRead(${n.id})">‚úì ${currentLang === 'kz' ? '–û“õ—ã–ª–¥—ã' : currentLang === 'en' ? 'Read' : '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ'}</button>` : ''}
        </div>`;
      });
    }
    const modal = document.getElementById('notificationsModal');
    document.getElementById('notificationsContent').innerHTML = html;
    openModal('notificationsModal');
    let updated = false;
    nots.forEach(n => { if (!n.read) { n.read = true; updated = true; } });
    if (updated) await saveNotifications(nots);
    renderAuthBlock();
  };
  
  window.markNotificationRead = async function(id) {
    let nots = await getNotifications();
    let n = nots.find(n => n.id === id);
    if (n) n.read = true;
    await saveNotifications(nots);
    openNotificationsModal();
    renderAuthBlock();
  };

  // ========== –ó–ê–ü–£–°–ö =========
  window.onload = async function() {
    await initFirebase();
    renderNavigation();
    await renderAuthBlock();
    switchSection('home');
    applyTranslations();
  };
</script>
</body>
</html>