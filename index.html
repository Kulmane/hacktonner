<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0">
  <title>–°–µ–º–µ–π ¬∑ –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞</title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
  <!-- Leaflet (–∫–∞—Ä—Ç–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-database-compat.min.js"></script>
  <style>
    /* ===== –°–¢–ò–õ–ò ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: #f5faff; color: #003f5c; display: flex; flex-direction: column; min-height: 100vh; }
    .container { max-width: 1320px; margin: 0 auto; padding: 0 24px; }
    :root { --egov-blue: #004a7c; --egov-gold: #f5c542; --egov-radius: 24px; --egov-shadow: 0 10px 25px -5px rgba(0,53,84,0.1); }
    .navbar { background: white; box-shadow: 0 6px 24px rgba(0,74,124,0.06); padding: 12px 0; border-bottom: 4px solid var(--egov-gold); position: sticky; top: 0; z-index: 100; }
    .navbar-inner { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 800; color: var(--egov-blue); }
    .logo i { color: var(--egov-gold); }
    .main-nav { display: flex; list-style: none; gap: 28px; font-weight: 600; flex-wrap: wrap; }
    .main-nav li a { color: #004a7c; padding: 8px 0; border-bottom: 3px solid transparent; text-decoration: none; transition: 0.2s; }
    .main-nav li a:hover, .main-nav li a.active { border-bottom-color: var(--egov-gold); color: #002d42; }
    .btn { padding: 10px 22px; border-radius: 40px; border: none; font-weight: 600; background: var(--egov-blue); color: white; cursor: pointer; transition: 0.2s; box-shadow: 0 6px 14px rgba(0,74,124,0.15); }
    .btn:hover { background: #002e4a; transform: translateY(-2px); }
    .btn-outline { background: transparent; border: 2px solid var(--egov-blue); color: var(--egov-blue); box-shadow: none; }
    .btn-outline:hover { background: var(--egov-blue); color: white; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .user-bar { display: flex; align-items: center; gap: 20px; background: #eef6ff; padding: 8px 20px; border-radius: 40px; border: 1px solid #c2dcf0; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { font-size: 1.3rem; }
    .user-name { font-weight: 700; color: var(--egov-blue); }
    .balance-badge { background: var(--egov-gold); color: #003f5c; padding: 4px 14px; border-radius: 30px; font-weight: 700; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(245,197,66,0.3); }
    .content-area { flex: 1; margin: 40px 0; }
    .section-header { display: flex; align-items: center; gap: 14px; margin-bottom: 32px; }
    .section-header i { font-size: 2.2rem; color: var(--egov-gold); }
    .section-header h2 { font-size: 1.9rem; font-weight: 700; color: #003357; }
    .grid-2, .grid-3, .grid-4 { display: grid; gap: 28px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .card { background: white; border-radius: var(--egov-radius); padding: 28px 24px; box-shadow: var(--egov-shadow); transition: 0.2s; border-bottom: 5px solid transparent; cursor: pointer; }
    .card:hover { border-bottom-color: var(--egov-gold); transform: translateY(-5px); }
    .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; color: #00426a; }
    .stat-card { text-align: center; padding: 20px; }
    .stat-number { font-size: 2.8rem; font-weight: 800; color: var(--egov-blue); line-height: 1; margin-bottom: 8px; }
    .badge { background: #f0f7fe; padding: 6px 16px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: #004a7c; }
    .fake-input { background: #f6fafe; padding: 14px 18px; border-radius: 16px; border: 1px solid #cde0ea; display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .fake-input input, .fake-input select, .fake-input textarea { border: none; background: transparent; width: 100%; outline: none; resize: vertical; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,53,84,0.7); backdrop-filter: blur(6px); align-items: center; justify-content: center; z-index: 999; }
    .modal.active { display: flex; }
    .modal-content { background: white; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 40px; border-radius: 32px; box-shadow: 0 30px 50px rgba(0,0,0,0.2); }
    .map-container { height: 400px; width: 100%; border-radius: 18px; margin-top: 20px; z-index: 1; }
    .mini-map { height: 300px; width: 100%; border-radius: 16px; margin-bottom: 20px; z-index: 1; }
    .notification-bell { position: relative; cursor: pointer; }
    .notification-count { position: absolute; top: -8px; right: -8px; background: #e03a3a; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 700; }
    .footer { background: white; border-radius: 40px 40px 0 0; padding: 40px 0 20px; margin-top: 40px; box-shadow: 0 -8px 20px rgba(0,0,0,0.02); }
    .event-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: var(--egov-shadow); }
    .event-image { width: 100%; height: 180px; object-fit: cover; background: linear-gradient(145deg, #004a7c, #002e4a); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; }
    .event-info { padding: 20px; }
    @media (max-width: 1000px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .navbar-inner { flex-direction: column; gap: 15px; } }
  </style>
</head>
<body>

<!-- ========== –ö–û–ù–§–ò–ì FIREBASE ========= -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCWgoXc-v5LalFfsbs9UJN-X-jcLwweTsY",
    authDomain: "udeee-8e07b.firebaseapp.com",
    databaseURL: "https://udeee-8e07b-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "udeee-8e07b",
    storageBucket: "udeee-8e07b.firebasestorage.app",
    messagingSenderId: "171875412311",
    appId: "1:171875412311:web:430d8f298e508f9556f612",
    measurementId: "G-GBMCGGF80Y"
  };
  firebase.initializeApp(firebaseConfig);
  const fbDB = firebase.database();
</script>

<!-- ========== –ú–û–î–ê–õ–ö–ò (–í–•–û–î, –û–¢–ó–´–í, –ü–õ–ê–ù, –û–¢–í–ï–¢, –û–ë–†–ê–©–ï–ù–ò–ï, –û–ü–õ–ê–¢–ê, –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø) ========= -->
<!-- (–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –∑–¥–µ—Å—å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω–æ, –Ω–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç) -->
<!-- ========== –ú–û–î–ê–õ–ö–ê –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ========= -->
<div id="authModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h3 style="color: #004a7c; font-size: 1.7rem; font-weight: 700;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <i class="fas fa-times" style="font-size: 1.6rem; color: #6c8fa0; cursor: pointer;" onclick="closeModal('authModal')"></i>
    </div>
    <div style="display: flex; flex-direction: column; gap: 24px;">
      <div style="display: flex; gap: 10px; border-bottom: 2px solid #eaf0f5; padding-bottom: 10px;">
        <button id="loginTabBtn" class="btn" style="flex:1;" onclick="showLoginForm()">–í—Ö–æ–¥</button>
        <button id="registerTabBtn" class="btn-outline" style="flex:1;" onclick="showRegisterForm()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
      <div id="loginForm">
        <div class="fake-input"><i class="fas fa-id-card"></i><input type="text" id="iinInput" placeholder="–ò–ò–ù (12 —Ü–∏—Ñ—Ä)" maxlength="12"></div>
        <div class="fake-input"><i class="fas fa-lock"></i><input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å"></div>
        <button class="btn" style="width:100%;" onclick="loginByIIN()"><i class="fas fa-arrow-right-to-bracket"></i> –í–æ–π—Ç–∏</button>
        <div style="margin-top:16px; text-align:center; color:#3a6e8c;">
          –¢–µ—Å—Ç: 100304223455/123 (–ê–∫–∏–º), 200105123456/123 (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å), 880101345678/123 (–ñ–∏—Ç–µ–ª—å)
        </div>
      </div>
      <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
      <div id="registerForm" style="display:none;">
        <div class="fake-input"><i class="fas fa-id-card"></i><input type="text" id="regIIN" placeholder="–ò–ò–ù (12 —Ü–∏—Ñ—Ä)" maxlength="12"></div>
        <div class="fake-input"><i class="fas fa-user"></i><input type="text" id="regName" placeholder="–§–ò–û"></div>
        <div class="fake-input"><i class="fas fa-lock"></i><input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)"></div>
        <button class="btn" style="width:100%; background:#0f6c4b;" onclick="registerCitizen()"><i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    </div>
  </div>
</div>
<div id="reviewModal" class="modal"><div class="modal-content">...</div></div>
<div id="planModal" class="modal"><div class="modal-content">...</div></div>
<div id="planDetailModal" class="modal"><div class="modal-content" id="planDetailContent"></div></div>
<div id="respondModal" class="modal"><div class="modal-content">...</div></div>
<div id="appealModal" class="modal"><div class="modal-content">...</div></div>
<div id="paymentModal" class="modal"><div class="modal-content" id="paymentContent"></div></div>
<div id="notificationsModal" class="modal"><div class="modal-content" id="notificationsContent"></div></div>

<!-- ========== –®–ê–ü–ö–ê (–ò–ú–Ø –ò –ë–ê–õ–ê–ù–° –°–ü–†–ê–í–ê –í –£–ì–õ–£) ========= -->
<header class="navbar">
  <div class="container navbar-inner">
    <div class="logo"><i class="fas fa-tree"></i> EcoSemey</div>
    <ul class="main-nav" id="navMenu"></ul>
    <div class="auth-badge" id="authBlock"></div>
  </div>
</header>

<!-- ========== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ========= -->
<main class="content-area container" id="dynamicContent"></main>

<!-- ========== –§–£–¢–ï–† ========= -->
<footer class="footer">
  <div class="container">
    <p style="text-align:center; color:#3e6a80;">¬© 2026 ‚Äì –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≥. –°–µ–º–µ–π</p>
  </div>
</footer>

<script>
  // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =========
  let currentUser = null;
  let map = null;
  let reviewMap = null, planMap = null;
  let reviewMarker = null, planMarker = null;
  let currentRespondReviewId = null;

  // ========== –§–£–ù–ö–¶–ò–ò FIREBASE =========
  async function getUsers() { const snap = await fbDB.ref('users').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveUsers(users) { const obj = {}; users.forEach((u,i)=>obj[i]=u); await fbDB.ref('users').set(obj); }
  async function findUserByIIN(iin) {
    const snap = await fbDB.ref('users').orderByChild('iin').equalTo(iin).once('value');
    const data = snap.val();
    return data ? Object.values(data)[0] : null;
  }
  async function getReviews() { const snap = await fbDB.ref('reviews').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveReviews(reviews) { const obj = {}; reviews.forEach((r,i)=>obj[i]=r); await fbDB.ref('reviews').set(obj); }
  async function getPlans() { const snap = await fbDB.ref('construction_plans').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function savePlans(plans) { const obj = {}; plans.forEach((p,i)=>obj[i]=p); await fbDB.ref('construction_plans').set(obj); }
  async function getNotifications() { const snap = await fbDB.ref('notifications').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveNotifications(notifs) { const obj = {}; notifs.forEach((n,i)=>obj[i]=n); await fbDB.ref('notifications').set(obj); }
  async function getEmployees() { const snap = await fbDB.ref('employees').once('value'); return snap.val() ? Object.values(snap.val()) : []; }
  async function saveEmployees(emps) { const obj = {}; emps.forEach((e,i)=>obj[i]=e); await fbDB.ref('employees').set(obj); }

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ =========
  async function initFirebase() {
    if (!(await fbDB.ref('users').once('value')).exists()) {
      await saveUsers([
        { iin: "100304223455", password: "123", role: "akim", name: "–ù—É—Ä—Å—É–ª—Ç–∞–Ω –ê.", avatar: "üë§", points: 1000 },
        { iin: "200105123456", password: "123", role: "ispolnitel", name: "–ë–µ—Ä–∏–∫ –ö.", avatar: "üîß", points: 500 },
        { iin: "880101345678", password: "123", role: "citizen", name: "–ê–π–≥—É–ª—å –ú.", avatar: "üè†", points: 250 },
        { iin: "900202112233", password: "123", role: "citizen", name: "–†—É—Å–ª–∞–Ω –¢.", avatar: "üè†", points: 120 }
      ]);
    }
    if (!(await fbDB.ref('employees').once('value')).exists()) {
      await saveEmployees([
        { id: 1, name: "–°–µ—Ä–∏–∫ –ê–±–∏—à–µ–≤", position: "–ë—Ä–∏–≥–∞–¥–∏—Ä", status: "active", rating: 4.5 },
        { id: 2, name: "–ê–π–Ω—É—Ä –°–∞–≥–∏–Ω—Ç–∞–µ–≤–∞", position: "–ú–∞—Å—Ç–µ—Ä –ñ–ö–•", status: "active", rating: 4.8 }
      ]);
    }
    if (!(await fbDB.ref('reviews').once('value')).exists()) {
      await saveReviews([
        { id: 1, userId: "880101345678", userName: "–ê–π–≥—É–ª—å –ú.", lat: 50.411, lng: 80.227, address: "—É–ª. –ê–±–∞—è, 12", text: "–Ø–º–∞ –Ω–∞ –¥–æ—Ä–æ–≥–µ —É–ª. –ê–±–∞—è", photo: null, rating: 0, points: 0, status: "active", date: "2026-02-20", responses: [], pointsAwarded: false }
      ]);
    }
    if (!(await fbDB.ref('construction_plans').once('value')).exists()) {
      await savePlans([
        { id: 1, lat: 50.419, lng: 80.245, address: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 45", title: "–ù–æ–≤–∞—è —à–∫–æ–ª–∞ ‚Ññ45", status: "–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è", builder: "–¢–û–û –°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç", permit: "–ê-123/2026", budget: "450 –º–ª–Ω ‚Ç∏", margin: "15%", salary: "12 –º–ª–Ω ‚Ç∏", materials: "210 –º–ª–Ω ‚Ç∏", lifetime: "50 –ª–µ—Ç", photos: [], videos: [], reports: [], createdBy: "akim" }
      ]);
    }
    if (!(await fbDB.ref('notifications').once('value')).exists()) {
      await saveNotifications([
        { id: 1, from: "–°–∏—Å—Ç–µ–º–∞", to: "all", text: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ü–∏—Ñ—Ä–æ–≤—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É –°–µ–º–µ—è!", date: new Date().toLocaleDateString(), read: false }
      ]);
    }
  }

  // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø =========
  async function loginByIIN() {
    const iin = document.getElementById('iinInput')?.value.trim();
    const pwd = document.getElementById('passwordInput')?.value.trim();
    if (!iin || !pwd) return alert("–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù –∏ –ø–∞—Ä–æ–ª—å");
    const user = await findUserByIIN(iin);
    if (!user) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if (user.password !== pwd) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    currentUser = user;
    closeModal('authModal');
    renderNavigation();
    renderAuthBlock();
    switchSection('home');
  }
  async function registerCitizen() {
    const iin = document.getElementById('regIIN').value.trim();
    const name = document.getElementById('regName').value.trim();
    const pwd = document.getElementById('regPassword').value.trim();
    if (!iin || !name || !pwd) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    if (iin.length !== 12 || !/^\d+$/.test(iin)) return alert("–ò–ò–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 12 —Ü–∏—Ñ—Ä");
    if (pwd.length < 4) return alert("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞");
    if (await findUserByIIN(iin)) return alert("–ò–ò–ù —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
    const users = await getUsers();
    users.push({ iin, password: pwd, role: "citizen", name, avatar: "üè†", points: 0 });
    await saveUsers(users);
    alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ.");
    showLoginForm();
    document.getElementById('iinInput').value = iin;
  }
  function logout() { currentUser = null; renderNavigation(); renderAuthBlock(); switchSection('home'); }

  // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò =========
  function openModal(id) { document.getElementById(id).classList.add('active'); }
  function closeModal(id) { document.getElementById(id).classList.remove('active'); }
  function showLoginForm() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginTabBtn').className = 'btn';
  document.getElementById('registerTabBtn').className = 'btn-outline';
}
function showRegisterForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
  document.getElementById('registerTabBtn').className = 'btn';
  document.getElementById('loginTabBtn').className = 'btn-outline';
}

  // ========== –†–ï–ù–î–ï–† –ù–ê–í–ò–ì–ê–¶–ò–ò =========
  function renderNavigation() {
    const nav = document.getElementById('navMenu'); nav.innerHTML = '';
    let items = [
      { id: 'home', title: '–ì–ª–∞–≤–Ω–∞—è', icon: 'fa-home' },
      { id: 'events', title: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', icon: 'fa-calendar-alt' },
      { id: 'reviews', title: '–û—Ç–∑—ã–≤—ã', icon: 'fa-comment' },
      { id: 'routes', title: '–ú–∞—Ä—à—Ä—É—Ç—ã', icon: 'fa-bus' },
      { id: 'clinics', title: '–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏', icon: 'fa-hospital' },
      { id: 'police', title: '–ü–æ–ª–∏—Ü–∏—è', icon: 'fa-shield-haltered' }
    ];
    if (currentUser) {
      if (currentUser.role === 'akim') items.push({ id: 'akimat', title: '–ê–∫–∏–º–∞—Ç', icon: 'fa-landmark' });
      if (currentUser.role === 'ispolnitel') items.push({ id: 'executors', title: '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏', icon: 'fa-hard-hat' });
      if (currentUser.role === 'citizen') items.push({ id: 'citizens', title: '–ñ–∏—Ç–µ–ª–∏', icon: 'fa-user-group' });
      items.push({ id: 'profile', title: '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç', icon: 'fa-id-card' });
      items.push({ id: 'map', title: '–ö–∞—Ä—Ç–∞', icon: 'fa-map' });
    } else {
      items.push({ id: 'map', title: '–ö–∞—Ä—Ç–∞', icon: 'fa-map' });
    }
    items.forEach(item => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#'; a.className = 'nav-link'; a.dataset.section = item.id;
      a.innerHTML = `<i class="fas ${item.icon}"></i> ${item.title}`;
      a.onclick = e => { e.preventDefault(); switchSection(item.id); };
      li.appendChild(a); nav.appendChild(li);
    });
  }

  // ========== –†–ï–ù–î–ï–† –ë–õ–û–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (–ò–ú–Ø –ò –ë–ê–õ–ê–ù–° –°–ü–†–ê–í–ê –í –£–ì–õ–£) =========
  async function renderAuthBlock() {
    const auth = document.getElementById('authBlock');
    if (!currentUser) {
      auth.innerHTML = `<button class="btn-outline btn" onclick="openModal('authModal')"><i class="fas fa-key"></i> –í—Ö–æ–¥</button>`;
      return;
    }
    const nots = await getNotifications();
    const unread = nots.filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).filter(n => !n.read).length;
    auth.innerHTML = `
      <div style="display:flex; align-items:center; gap:20px;">
        <div class="notification-bell" onclick="openNotificationsModal()">
          <i class="fas fa-bell" style="font-size:1.4rem;"></i>
          ${unread ? `<span class="notification-count">${unread}</span>` : ''}
        </div>
        <div class="user-bar">
          <div class="user-info">
            <span class="user-avatar">${currentUser.avatar}</span>
            <span class="user-name">${currentUser.name}</span>
          </div>
          <div class="balance-badge">
            <i class="fas fa-star"></i> ${currentUser.points || 0} ‚Ç∏
          </div>
          <button class="btn-outline btn-sm" onclick="logout()" title="–í—ã–π—Ç–∏">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    `;
  }

  // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ê–ó–î–ï–õ–û–í =========
  async function switchSection(sectionId) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    const active = Array.from(document.querySelectorAll('.nav-link')).find(l => l.dataset.section === sectionId);
    if (active) active.classList.add('active');

    if (!currentUser && ['akimat','executors','citizens','profile'].includes(sectionId)) sectionId = 'home';
    if (currentUser) {
      if (sectionId === 'akimat' && currentUser.role !== 'akim') sectionId = 'home';
      if (sectionId === 'executors' && currentUser.role !== 'ispolnitel') sectionId = 'home';
      if (sectionId === 'citizens' && currentUser.role !== 'citizen') sectionId = 'home';
    }
    const content = document.getElementById('dynamicContent');
    switch (sectionId) {
      case 'home': content.innerHTML = await renderHome(); break;
      case 'events': content.innerHTML = await renderEvents(); break;
      case 'profile': content.innerHTML = await renderProfile(); break;
      case 'akimat': content.innerHTML = await renderAkimat(); break;
      case 'executors': content.innerHTML = await renderExecutors(); break;
      case 'citizens': content.innerHTML = await renderCitizens(); break;
      case 'map': content.innerHTML = await renderMap(); setTimeout(() => initMap(), 200); break;
      case 'reviews': content.innerHTML = await renderReviewsPage(); break;
      case 'routes': content.innerHTML = await renderRoutesPage(); break;
      case 'clinics': content.innerHTML = await renderClinicsPage(); break;
      case 'police': content.innerHTML = await renderPolicePage(); break;
      default: content.innerHTML = await renderHome();
    }
  }

  // ---------- –ì–õ–ê–í–ù–ê–Ø ----------
  async function renderHome() {
    const reviews = await getReviews();
    return `<div class="section-header"><i class="fas fa-city"></i><h2>–ì–æ—Ä–æ–¥ –°–µ–º–µ–π</h2></div>
      <div class="grid-4">
        <div class="card stat-card" onclick="switchSection('clinics')">
          <div class="stat-number">9</div>
          <div style="font-size:1.1rem; font-weight:600;">–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫</div>
          <p style="color:#6c8fa0; margin-top:8px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
        </div>
        <div class="card stat-card" onclick="switchSection('police')">
          <div class="stat-number">8</div>
          <div style="font-size:1.1rem; font-weight:600;">–£—á–∞—Å—Ç–∫–æ–≤ –ø–æ–ª–∏—Ü–∏–∏</div>
          <p style="color:#6c8fa0; margin-top:8px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
        </div>
        <div class="card stat-card" onclick="switchSection('routes')">
          <div class="stat-number">24</div>
          <div style="font-size:1.1rem; font-weight:600;">–ú–∞—Ä—à—Ä—É—Ç–æ–≤</div>
          <p style="color:#6c8fa0; margin-top:8px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
        </div>
        <div class="card stat-card" onclick="switchSection('reviews')">
          <div class="stat-number">${reviews.length}</div>
          <div style="font-size:1.1rem; font-weight:600;">–û—Ç–∑—ã–≤–æ–≤</div>
          <p style="color:#6c8fa0; margin-top:8px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
        </div>
      </div>
      <div class="grid-2" style="margin-top:28px;">
        <div class="card" onclick="switchSection('events')">
          <div class="card-title"><i class="fas fa-calendar-alt"></i> –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <p>25.02 ‚Äî –ö–æ–Ω—Ü–µ—Ä—Ç ¬´–ú–µ–ª–æ–¥–∏–∏ —Å—Ç–µ–ø–∏¬ª</p>
          <p>01.03 ‚Äî –í—ã—Å—Ç–∞–≤–∫–∞ –º–æ–ª–æ–¥—ã—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤</p>
          <p>05.03 ‚Äî –í–µ–ª–æ–ø—Ä–æ–±–µ–≥ ¬´–ó–µ–ª–µ–Ω—ã–π –°–µ–º–µ–π¬ª</p>
          <span style="color:var(--egov-blue); margin-top:12px; display:block;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π ‚Üí</span>
        </div>
        <div class="card" onclick="switchSection('map')">
          <div class="card-title"><i class="fas fa-map-marked-alt"></i> –ö–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥–∞</div>
          <p>–ü—Ä–æ–±–ª–µ–º—ã, –ø–ª–∞–Ω—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –ø–æ–ª–∏—Ü–∏—è</p>
          <span style="color:var(--egov-blue); margin-top:12px; display:block;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ä—Ç–µ ‚Üí</span>
        </div>
      </div>`;
  }

  // ---------- –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ----------
  async function renderEvents() {
    const events = [
      { title: "–ö–æ–Ω—Ü–µ—Ä—Ç ¬´–ú–µ–ª–æ–¥–∏–∏ —Å—Ç–µ–ø–∏¬ª", date: "25 —Ñ–µ–≤—Ä–∞–ª—è 2026", place: "–î—Ä–∞–º—Ç–µ–∞—Ç—Ä", image: "üéµ" },
      { title: "–í—ã—Å—Ç–∞–≤–∫–∞ –º–æ–ª–æ–¥—ã—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤", date: "1-10 –º–∞—Ä—Ç–∞ 2026", place: "–û–±–ª–∞—Å—Ç–Ω–æ–π –º—É–∑–µ–π", image: "üé®" },
      { title: "–í–µ–ª–æ–ø—Ä–æ–±–µ–≥ ¬´–ó–µ–ª–µ–Ω—ã–π –°–µ–º–µ–π¬ª", date: "5 –º–∞—Ä—Ç–∞ 2026", place: "–ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã", image: "üö¥" },
      { title: "–î–µ–Ω—å –≥–æ—Ä–æ–¥–∞", date: "15 –∞–ø—Ä–µ–ª—è 2026", place: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å", image: "üèõÔ∏è" },
      { title: "–Ø—Ä–º–∞—Ä–∫–∞ —Ä–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–æ–≤", date: "20-22 –º–∞—Ä—Ç–∞ 2026", place: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω", image: "üß∂" },
      { title: "–î–µ—Ç—Å–∫–∏–π —Å–ø–µ–∫—Ç–∞–∫–ª—å", date: "12 –º–∞—Ä—Ç–∞ 2026", place: "–¢–µ–∞—Ç—Ä –∫—É–∫–æ–ª", image: "üß∏" }
    ];
    return `<div class="section-header"><i class="fas fa-calendar-alt"></i><h2>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –°–µ–º–µ—è</h2></div>
      <div class="grid-3">
        ${events.map(e => `
          <div class="event-card">
            <div class="event-image">${e.image}</div>
            <div class="event-info">
              <h3 style="font-size:1.2rem; margin-bottom:8px;">${e.title}</h3>
              <p style="color:#6c8fa0;"><i class="fas fa-calendar"></i> ${e.date}</p>
              <p style="color:#6c8fa0;"><i class="fas fa-map-marker-alt"></i> ${e.place}</p>
            </div>
          </div>
        `).join('')}
      </div>`;
  }

  // ---------- –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ----------
  async function renderProfile() {
    if (!currentUser) return '';
    const nots = (await getNotifications()).filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).slice(-5);
    return `<div class="section-header"><i class="fas fa-id-card"></i><h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-user"></i> –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</div>
          <ul class="list-menu">
            <li><i class="fas fa-hashtag"></i> –ò–ò–ù: ${currentUser.iin}</li>
            <li><i class="fas fa-user"></i> –§–ò–û: ${currentUser.name}</li>
            <li><i class="fas fa-tag"></i> –†–æ–ª—å: ${currentUser.role}</li>
            <li><i class="fas fa-star"></i> –ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤: <span id="userPoints">${currentUser.points || 0}</span> ‚Ç∏</li>
          </ul>
          ${currentUser.role === 'citizen' ? `<button class="btn" style="margin-top:20px;" onclick="openAppealModal()"><i class="fas fa-paper-plane"></i> –õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∞–∫–∏–º—É</button>` : ''}
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-bell"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
          ${nots.length ? nots.map(n => `<p style="border-bottom:1px solid #eee; padding:8px 0;">${n.text}</p>`).join('') : '<p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>'}
        </div>
      </div>
      <div class="card" style="margin-top:28px; cursor:default;">
        <div class="card-title"><i class="fas fa-credit-card"></i> –ù–∞–ª–æ–≥–∏ –∏ –ø–ª–∞—Ç–µ–∂–∏</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
          <button class="btn" onclick="openPaymentModal('tax')"><i class="fas fa-file-invoice"></i> –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤</button>
          <button class="btn" onclick="openPaymentModal('fine')"><i class="fas fa-exclamation-triangle"></i> –û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–æ–≤</button>
          <button class="btn" onclick="openPaymentModal('utility')"><i class="fas fa-bolt"></i> –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</button>
        </div>
        <p style="margin-top:16px; color:#004a7c;"><i class="fas fa-coins"></i> 1 –±–∞–ª–ª = 1 ‚Ç∏. –í—ã –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ –ª—é–±—É—é —É—Å–ª—É–≥—É.</p>
      </div>`;
  }

  // ---------- –û–ë–†–ê–©–ï–ù–ò–ï –ö –ê–ö–ò–ú–£ ----------
  window.openAppealModal = function() {
    document.getElementById('appealName').value = currentUser.name;
    document.getElementById('appealIIN').value = currentUser.iin;
    document.getElementById('appealText').value = '';
    openModal('appealModal');
  };
  window.sendAppeal = async function() {
    const text = document.getElementById('appealText').value.trim();
    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è");
    const nots = await getNotifications();
    nots.push({
      id: Date.now(),
      from: `–ñ–∏—Ç–µ–ª—å ${currentUser.name}`,
      to: 'role',
      role: 'akim',
      text: `–õ–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ: ${text}`,
      date: new Date().toLocaleDateString(),
      read: false
    });
    await saveNotifications(nots);
    alert("–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–∫–∏–º—É!");
    closeModal('appealModal');
  };

  // ---------- –ü–õ–ê–¢–Å–ñ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ----------
  window.openPaymentModal = function(type) {
    let html = `<div style="display:flex; justify-content:space-between;"><h3 style="color:#004a7c;">–û–ø–ª–∞—Ç–∞</h3><i class="fas fa-times" style="font-size:1.6rem; color:#6c8fa0; cursor:pointer;" onclick="closeModal('paymentModal')"></i></div>`;
    if (type === 'tax') {
      html += `<p>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥:</p>
        <select id="paymentSelect" class="fake-input">
          <option value="25000">–ù–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ - 25 000 ‚Ç∏</option>
          <option value="15000">–ó–µ–º–µ–ª—å–Ω—ã–π –Ω–∞–ª–æ–≥ - 15 000 ‚Ç∏</option>
          <option value="8000">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π –Ω–∞–ª–æ–≥ - 8 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-id-card"></i><input id="taxIIN" placeholder="–ò–ò–ù" value="${currentUser?.iin || ''}"></div>`;
    } else if (type === 'fine') {
      html += `<p>–í—ã–±–µ—Ä–∏—Ç–µ —à—Ç—Ä–∞—Ñ:</p>
        <select id="paymentSelect" class="fake-input">
          <option value="5000">–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ - 5 000 ‚Ç∏</option>
          <option value="10000">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ - 10 000 ‚Ç∏</option>
          <option value="15000">–ü—Ä–æ–µ–∑–¥ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π - 15 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-car"></i><input id="carNumber" placeholder="–ù–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è"></div>`;
    } else if (type === 'utility') {
      html += `<p>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:</p>
        <select id="paymentSelect" class="fake-input">
          <option value="8000">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ - 8 000 ‚Ç∏</option>
          <option value="4500">–í–æ–¥–∞ - 4 500 ‚Ç∏</option>
          <option value="6000">–ì–∞–∑ - 6 000 ‚Ç∏</option>
        </select>
        <div class="fake-input"><i class="fas fa-id-card"></i><input id="utilityIIN" placeholder="–ò–ò–ù" value="${currentUser?.iin || ''}"></div>
        <div class="fake-input"><i class="fas fa-map-marker-alt"></i><input id="utilityAddress" placeholder="–ê–¥—Ä–µ—Å, –∫–≤–∞—Ä—Ç–∏—Ä–∞"></div>`;
    }
    html += `<p style="margin-top:20px;">–°—É–º–º–∞: <span id="paymentAmount">0</span> ‚Ç∏</p>
      <button class="btn" onclick="calculatePayment()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
      <div id="paymentMethods" style="margin-top:20px; display:none;">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</p>
        <button class="btn-outline" onclick="payWithCard()">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</button>
        <button class="btn-outline" onclick="payWithPoints()">‚≠ê –û–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏</button>
        <button class="btn-outline" onclick="payWithKaspi()">üíö Kaspi.kz</button>
        <button class="btn-outline" onclick="payWithHalyk()">üè¶ Halyk Bank</button>
        <button class="btn-outline" onclick="payWithApplePay()">üçè Apple Pay</button>
      </div>`;
    const modal = document.getElementById('paymentModal');
    modal.querySelector('#paymentContent').innerHTML = html;
    openModal('paymentModal');
  };
  window.calculatePayment = function() {
    const select = document.getElementById('paymentSelect');
    const amount = parseInt(select.value, 10);
    document.getElementById('paymentAmount').innerText = amount;
    document.getElementById('paymentMethods').style.display = 'block';
  };
  window.payWithPoints = async function() {
    const amount = parseInt(document.getElementById('paymentAmount').innerText, 10);
    const pointsNeeded = amount;
    if ((currentUser.points || 0) < pointsNeeded) {
      alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è ${pointsNeeded}, —É –≤–∞—Å ${currentUser.points || 0}`);
      return;
    }
    let users = await getUsers();
    let user = users.find(u => u.iin === currentUser.iin);
    if (user) {
      user.points = (user.points || 0) - pointsNeeded;
      currentUser.points = user.points;
      await saveUsers(users);
      alert(`–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –°–ø–∏—Å–∞–Ω–æ ${pointsNeeded} –±–∞–ª–ª–æ–≤.`);
      closeModal('paymentModal');
      const pointsSpan = document.getElementById('userPoints');
      if (pointsSpan) pointsSpan.innerText = user.points;
      renderAuthBlock();
    }
  };
  window.payWithCard = function() { alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑ –¥–ª—è –∫–∞—Ä—Ç—ã..."); closeModal('paymentModal'); };
  window.payWithKaspi = function() { alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Kaspi.kz..."); closeModal('paymentModal'); };
  window.payWithHalyk = function() { alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Halyk Bank..."); closeModal('paymentModal'); };
  window.payWithApplePay = function() { alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Apple Pay..."); closeModal('paymentModal'); };

  // ========== –ö–ê–†–¢–ê –° –ù–û–†–ú–ê–õ–¨–ù–´–ú–ò –ó–ù–ê–ß–ö–ê–ú–ò =========
  function getMarkerIcon(type) {
    if (type === 'review') return L.divIcon({ html: '<i class="fas fa-comment" style="color:#004a7c; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'plan') return L.divIcon({ html: '<i class="fas fa-hard-hat" style="color:#f5c542; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'police') return L.divIcon({ html: '<i class="fas fa-shield-haltered" style="color:#d32f2f; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    if (type === 'clinic') return L.divIcon({ html: '<i class="fas fa-plus-circle" style="color:#2e7d32; font-size:24px;"></i>', iconSize: [30,30], className: 'marker-icon' });
    return L.divIcon({ html: '<i class="fas fa-map-marker" style="color:#004a7c; font-size:24px;"></i>', iconSize: [30,30] });
  }

  async function renderMap() {
    return `<div class="section-header"><i class="fas fa-map"></i><h2>–ö–∞—Ä—Ç–∞ –°–µ–º–µ—è</h2></div>
      <div id="mapContainer" class="map-container"></div>
      <div style="margin-top:20px;">
        ${currentUser ? `<button class="btn" onclick="openReviewModal()"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>` : ''}
        ${currentUser && (currentUser.role === 'akim' || currentUser.role === 'ispolnitel') ? `<button class="btn" style="margin-left:16px;" onclick="openPlanModal()"><i class="fas fa-hard-hat"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</button>` : ''}
      </div>`;
  }

  async function initMap() {
    if (!document.getElementById('mapContainer')) return;
    if (map) map.remove();
    map = L.map('mapContainer').setView([50.411, 80.227], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    }).addTo(map);

    const reviews = await getReviews();
    reviews.forEach(r => {
      if (r.status === 'active' && r.lat && r.lng) {
        const marker = L.marker([r.lat, r.lng], { icon: getMarkerIcon('review') }).addTo(map);
        let popupContent = `<b>${r.userName}</b><br>${r.text}<br>‚≠ê ${r.rating} | üèÖ ${r.points || 0} –±–∞–ª–ª–æ–≤<br>`;
        if (r.address) popupContent += `<i>${r.address}</i><br>`;
        if (currentUser?.role === 'akim' && !r.pointsAwarded) {
          popupContent += `<button onclick="approveReview(${r.id})" style="margin:2px; background:#004a7c; color:white; border:none; padding:5px 10px; border-radius:20px;">+500 –±–∞–ª–ª–æ–≤</button>`;
        }
        if (currentUser?.role === 'akim' || currentUser?.role === 'ispolnitel') {
          popupContent += `<button onclick="openRespondModal(${r.id}, '${r.userName}')" style="margin:2px; background:#f5c542; color:#003f5c; border:none; padding:5px 10px; border-radius:20px;">–û—Ç–≤–µ—Ç–∏—Ç—å</button>`;
        }
        marker.bindPopup(popupContent);
      }
    });

    const plans = await getPlans();
    plans.forEach(p => {
      if (p.lat && p.lng) {
        const marker = L.marker([p.lat, p.lng], { icon: getMarkerIcon('plan') }).addTo(map);
        marker.bindPopup(`<b>${p.title}</b><br>–°—Ç–∞—Ç—É—Å: ${p.status}<br><button onclick="showPlanDetail(${p.id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>`);
      }
    });

    const policeStations = getPoliceStations();
    policeStations.forEach(p => {
      const marker = L.marker([p.lat, p.lng], { icon: getMarkerIcon('police') }).addTo(map);
      marker.bindPopup(`<b>${p.name}</b><br>${p.address}<br>üìû ${p.phone}`);
    });

    const clinics = [
      { name: "–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ1", address: "—É–ª. –ê—É—ç–∑–æ–≤–∞, 12", phone: "8 (7222) 56-78-90", lat: 50.409, lng: 80.230 },
      { name: "–î–µ—Ç—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ3", address: "—É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞, 45", phone: "8 (7222) 33-22-11", lat: 50.415, lng: 80.240 }
    ];
    clinics.forEach(c => {
      const marker = L.marker([c.lat, c.lng], { icon: getMarkerIcon('clinic') }).addTo(map);
      marker.bindPopup(`<b>${c.name}</b><br>${c.address}<br>üìû ${c.phone}`);
    });
  }

  // ========== –ú–û–î–ê–õ–ö–ê –û–¢–ó–´–í–ê =========
  window.openReviewModal = function() { /* ... –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ ... */ };
  window.closeReviewModal = function() { /* ... */ };
  window.submitReview = async function() { /* ... */ };

  // ========== –ú–û–î–ê–õ–ö–ê –ü–õ–ê–ù–ê =========
  window.openPlanModal = function() { /* ... */ };
  window.closePlanModal = function() { /* ... */ };
  window.addPlan = async function() { /* ... */ };

  // ========== –ê–ö–ò–ú: –ë–ê–õ–õ–´ (–¢–û–õ–¨–ö–û 500 –ò –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó) =========
  window.approveReview = async function(id) {
    let reviews = await getReviews();
    let rev = reviews.find(r => r.id === id);
    if (!rev) return;
    if (rev.pointsAwarded) {
      alert("–ó–∞ —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤ —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –±–∞–ª–ª—ã (–º–∞–∫—Å–∏–º—É–º 500)");
      return;
    }
    rev.points = (rev.points || 0) + 500;
    rev.pointsAwarded = true;
    rev.rating = Math.min(5, rev.rating + 1);
    await saveReviews(reviews);
    let users = await getUsers();
    let user = users.find(u => u.iin === rev.userId);
    if (user) {
      user.points = (user.points || 0) + 500;
      if (currentUser && currentUser.iin === user.iin) currentUser.points = user.points;
      await saveUsers(users);
    }
    alert("–û—Ç–∑—ã–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, +500 –±–∞–ª–ª–æ–≤ –∂–∏—Ç–µ–ª—é");
    renderAuthBlock();
    if (document.querySelector('.nav-link.active')?.dataset.section === 'map') await initMap();
  };

  window.openRespondModal = function(reviewId, userName) {
    currentRespondReviewId = reviewId;
    document.getElementById('respondReviewInfo').innerHTML = `–û—Ç–≤–µ—Ç –¥–ª—è <strong>${userName}</strong>`;
    document.getElementById('respondText').value = '';
    openModal('respondModal');
  };
  window.sendResponse = async function() {
    const text = document.getElementById('respondText').value.trim();
    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞");
    const reviews = await getReviews();
    const review = reviews.find(r => r.id === currentRespondReviewId);
    if (!review) return;
    if (!review.responses) review.responses = [];
    review.responses.push({
      from: currentUser.name,
      role: currentUser.role,
      text: text,
      date: new Date().toLocaleDateString()
    });
    await saveReviews(reviews);
    const nots = await getNotifications();
    nots.push({
      id: Date.now(),
      from: `${currentUser.role === 'akim' ? '–ê–∫–∏–º' : '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'} ${currentUser.name}`,
      to: 'user',
      userIin: review.userId,
      text: `–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –æ—Ç–∑—ã–≤: ${text}`,
      date: new Date().toLocaleDateString(),
      read: false
    });
    await saveNotifications(nots);
    alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    closeModal('respondModal');
  };

  // ---------- –°–¢–†–ê–ù–ò–¶–´ ----------
  async function renderReviewsPage() {
    const reviews = await getReviews();
    return `<div class="section-header"><i class="fas fa-comment"></i><h2>–í—Å–µ –æ—Ç–∑—ã–≤—ã</h2></div>
      <div class="grid-3">${reviews.map(r => `<div class="card" style="cursor:default;">
        <p><strong>${r.userName}</strong> <span class="badge">‚≠ê ${r.rating} | üèÖ ${r.points}</span></p>
        <p>${r.text}</p>
        ${r.address ? `<p><i class="fas fa-map-marker-alt"></i> ${r.address}</p>` : ''}
        ${r.responses && r.responses.length ? `<div style="margin-top:12px; padding-left:12px; border-left:3px solid var(--egov-gold);">
          ${r.responses.map(resp => `<p><small><strong>${resp.from} (${resp.role})</strong> ${resp.date}</small><br>${resp.text}</p>`).join('')}
        </div>` : ''}
      </div>`).join('')}</div>`;
  }

  async function renderRoutesPage() {
    const routes = [
      { num: 1, name: "–í–æ—Å—Ö–æ–¥ ‚Äì –¶–µ–Ω—Ç—Ä", interval: "10 –º–∏–Ω" },
      { num: 2, name: "–î–∞—á–Ω—ã–π ‚Äì –ê—ç—Ä–æ–ø–æ—Ä—Ç", interval: "15 –º–∏–Ω" },
      { num: 3, name: "–ñ–∞–Ω–∞-–°–µ–º–µ–π ‚Äì –ñ/–¥ –≤–æ–∫–∑–∞–ª", interval: "12 –º–∏–Ω" },
      { num: 4, name: "–ö–•–¢–ò ‚Äì –®–∞–∫–∞—Ä–∏–º–∞", interval: "20 –º–∏–Ω" },
      { num: 5, name: "–º–∫—Ä. –ë–æ–±—Ä–æ–≤–æ ‚Äì –î—Ä–∞–º—Ç–µ–∞—Ç—Ä", interval: "18 –º–∏–Ω" },
      { num: 6, name: "–¶–µ–º–µ–Ω—Ç–Ω—ã–π –∑–∞–≤–æ–¥ ‚Äì –ø–æ—Å. –í–æ—Å—Ç–æ—á–Ω—ã–π", interval: "25 –º–∏–Ω" },
      { num: 7, name: "–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª ‚Äì –ö–æ–∂–∑–∞–≤–æ–¥", interval: "17 –º–∏–Ω" },
      { num: 8, name: "—É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞ ‚Äì –º–∫—Ä. –ö–∞—Ä–∞–≥–∞–π–ª—ã", interval: "14 –º–∏–Ω" },
      { num: 9, name: "–ø—Ä. –ê—É—ç–∑–æ–≤–∞ ‚Äì –ö–ì–£ –∏–º. –®–∞–∫–∞—Ä–∏–º–∞", interval: "12 –º–∏–Ω" },
      { num: 10, name: "–°–∏–ª–∏–∫–∞—Ç–Ω—ã–π ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫", interval: "22 –º–∏–Ω" },
      { num: 11, name: "—É–ª. –î—É–ª–∞—Ç–æ–≤–∞ ‚Äì –ó–µ–ª–µ–Ω—ã–π –±–∞–∑–∞—Ä", interval: "16 –º–∏–Ω" },
      { num: 12, name: "–∂/–º –ö–æ–∫—Ç–µ–º ‚Äì –ø–µ–¥–∏–Ω—Å—Ç–∏—Ç—É—Ç", interval: "19 –º–∏–Ω" },
      { num: 13, name: "–¢–≠–¶ ‚Äì –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ù–∞–π–∑–∞", interval: "30 –º–∏–Ω" },
      { num: 14, name: "–Æ–±–∏–ª–µ–π–Ω—ã–π ‚Äì –ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä", interval: "20 –º–∏–Ω" },
      { num: 15, name: "–ö–•–¢–ò ‚Äì –õ–æ–∫–æ–º–æ—Ç–∏–≤–Ω–æ–µ –¥–µ–ø–æ", interval: "24 –º–∏–Ω" },
      { num: 16, name: "–°—Ç–∞–Ω—Ü–∏—è –ñ–∞–Ω–∞-–°–µ–º–µ–π ‚Äì –ø–æ—Å. –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫", interval: "35 –º–∏–Ω" },
      { num: 17, name: "–ê—ç—Ä–æ–ø–æ—Ä—Ç ‚Äì –º–∫—Ä. –ó–∞—Ç–æ–Ω", interval: "40 –º–∏–Ω" },
      { num: 18, name: "—É–ª. –ß–µ—Ö–æ–≤–∞ ‚Äì –º–∫—Ä. –°—Ç—Ä–µ–ª–∫–∞", interval: "15 –º–∏–Ω" },
      { num: 19, name: "–î–∞—á–Ω—ã–π ‚Äì –û–ø—ã—Ç–Ω–æ–µ –ø–æ–ª–µ", interval: "20 –º–∏–Ω" },
      { num: 20, name: "–ê–≤—Ç–æ—Å—Ç–∞–Ω—Ü–∏—è –í–æ—Å—Ç–æ—á–Ω–∞—è ‚Äì –º–∫—Ä. –°–∞—è–∂–∞–π", interval: "25 –º–∏–Ω" },
      { num: 21, name: "–°–ú–ü-336 ‚Äì –æ–±–ª–∞—Å—Ç–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞", interval: "18 –º–∏–Ω" },
      { num: 22, name: "–º–∫—Ä. –ë–∞—Ç—ã—Ä ‚Äì –ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã", interval: "12 –º–∏–Ω" },
      { num: 23, name: "—É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞ ‚Äì –ö–•–¢–ò", interval: "15 –º–∏–Ω" },
      { num: 24, name: "–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω—Å–∫–∞—è ‚Äì –º–∫—Ä. –ñ—É–ª–¥—ã–∑", interval: "22 –º–∏–Ω" }
    ];
    return `<div class="section-header"><i class="fas fa-bus"></i><h2>–ú–∞—Ä—à—Ä—É—Ç—ã –°–µ–º–µ—è</h2></div><div class="grid-4">${routes.map(r => `<div class="card" style="cursor:default;"><h3>üöå ‚Ññ${r.num}</h3><p>${r.name}</p><p><i class="fas fa-clock"></i> ${r.interval}</p></div>`).join('')}</div>`;
  }

  async function renderClinicsPage() {
    const clinics = [
      { name: "–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ1", address: "—É–ª. –ê—É—ç–∑–æ–≤–∞, 12", phone: "8 (7222) 56-78-90", hours: "08:00‚Äì20:00" },
      { name: "–î–µ—Ç—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ3", address: "—É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞, 45", phone: "8 (7222) 33-22-11", hours: "08:00‚Äì18:00" },
      { name: "–í–∑—Ä–æ—Å–ª–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ4", address: "–ø—Ä. –®–∞–∫–∞—Ä–∏–º–∞, 101", phone: "8 (7222) 44-55-66", hours: "08:00‚Äì20:00" },
      { name: "–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ2", address: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 60", phone: "8 (7222) 77-88-99", hours: "09:00‚Äì19:00" },
      { name: "–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ5", address: "—É–ª. –ë–µ–ª–∏–Ω—Å–∫–æ–≥–æ, 30", phone: "8 (7222) 11-22-33", hours: "08:00‚Äì19:00" },
      { name: "–î–µ—Ç—Å–∫–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ2", address: "—É–ª. –ö—Ä–∞—Å–∏–Ω–∞, 7", phone: "8 (7222) 44-55-77", hours: "08:00‚Äì18:00" },
      { name: "–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ –ö–ì–ú–£", address: "—É–ª. –ë–∞–π—Ç—É—Ä—Å—ã–Ω–æ–≤–∞, 21", phone: "8 (7222) 99-88-77", hours: "09:00‚Äì17:00" },
      { name: "–¶–µ–Ω—Ç—Ä —Å–µ–º–µ–π–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã", address: "—É–ª. –ü–∞–≤–ª–æ–≤–∞, 15", phone: "8 (7222) 66-55-44", hours: "08:00‚Äì20:00" },
      { name: "–ñ–µ–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è ‚Ññ1", address: "—É–ª. –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, 58", phone: "8 (7222) 33-44-55", hours: "08:00‚Äì18:00" }
    ];
    return `<div class="section-header"><i class="fas fa-hospital"></i><h2>–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏</h2></div><div class="grid-3">${clinics.map(c => `<div class="card" style="cursor:default;"><h3>üè• ${c.name}</h3><p>üìç ${c.address}</p><p>üìû ${c.phone}</p><p>üïí ${c.hours}</p></div>`).join('')}</div>`;
  }

  function getPoliceStations() {
    return [
      { id: 1, name: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ü–∏–∏ –≥. –°–µ–º–µ–π", address: "—É–ª. –®—É–≥–∞–µ–≤–∞, 62", phone: "8 (7222) 52-40-01", lat: 50.421, lng: 80.245 },
      { id: 2, name: "–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ1 (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)", address: "—É–ª. –î—É–ª–∞—Ç–æ–≤–∞, 12", phone: "8 (7222) 56-30-20", lat: 50.411, lng: 80.237 },
      { id: 3, name: "–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ2 (–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π)", address: "—É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, 80", phone: "8 (7222) 33-40-50", lat: 50.400, lng: 80.220 },
      { id: 4, name: "–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ3 (–í–æ—Å—Ç–æ—á–Ω—ã–π)", address: "—É–ª. –ö–∞–º–∑–∏–Ω–∞, 15", phone: "8 (7222) 44-55-66", lat: 50.435, lng: 80.270 },
      { id: 5, name: "–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ4 (–ö–∞—Ä–∞–≥–∞–π–ª—ã)", address: "–º–∫—Ä. –ö–∞—Ä–∞–≥–∞–π–ª—ã, 5", phone: "8 (7222) 77-88-99", lat: 50.385, lng: 80.300 },
      { id: 6, name: "–û—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏ ‚Ññ5 (–ó–∞–ø–∞–¥–Ω—ã–π)", address: "–ø–æ—Å. –ó–∞–ø–∞–¥–Ω—ã–π, —É–ª. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è, 10", phone: "8 (7222) 66-55-44", lat: 50.450, lng: 80.180 },
      { id: 7, name: "–ë–∞—Ç–∞–ª—å–æ–Ω –¥–æ—Ä–æ–∂–Ω–æ–π –ø–æ–ª–∏—Ü–∏–∏", address: "–ø—Ä. –®–∞–∫–∞—Ä–∏–º–∞, 200", phone: "8 (7222) 53-30-40", lat: 50.415, lng: 80.255 },
      { id: 8, name: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ü–∏–∏", address: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 35", phone: "8 (7222) 52-60-70", lat: 50.408, lng: 80.242 }
    ];
  }
  async function renderPolicePage() {
    setTimeout(() => initPoliceMap(), 200);
    const stations = getPoliceStations();
    return `<div class="section-header"><i class="fas fa-shield-haltered"></i><h2>–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ —É—á–∞—Å—Ç–∫–∏</h2></div>
      <div id="policeMapContainer" class="map-container" style="height:400px;"></div>
      <div class="grid-3" style="margin-top:28px;">${stations.map(s => `<div class="card" style="cursor:default;"><h3><i class="fas fa-shield" style="color:#d32f2f;"></i> ${s.name}</h3><p>üìç ${s.address}</p><p>üìû ${s.phone}</p></div>`).join('')}</div>`;
  }
  function initPoliceMap() {
    if (!document.getElementById('policeMapContainer')) return;
    const policeMap = L.map('policeMapContainer').setView([50.411, 80.227], 12);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' }).addTo(policeMap);
    getPoliceStations().forEach(s => {
      const marker = L.marker([s.lat, s.lng], { icon: getMarkerIcon('police') }).addTo(policeMap);
      marker.bindPopup(`<b>${s.name}</b><br>${s.address}<br>üìû ${s.phone}`);
    });
  }

  // ---------- –ê–ö–ò–ú–ê–¢, –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò, –ñ–ò–¢–ï–õ–ò ----------
  async function renderAkimat() {
    const employees = await getEmployees();
    return `<div class="section-header"><i class="fas fa-landmark"></i><h2>–ü–∞–Ω–µ–ª—å –∞–∫–∏–º–∞</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</div>
          <div style="max-height:300px; overflow-y:auto;">
            ${employees.filter(e => e.status === 'active').map(e => `
              <div class="employee-row">
                <div><strong>${e.name}</strong><br><small>${e.position} ¬∑ –†–µ–π—Ç–∏–Ω–≥: ${e.rating || '‚Äî'}</small></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn-outline btn-sm" onclick="promoteEmployee(${e.id})"><i class="fas fa-arrow-up"></i> –ü–æ–≤—ã—Å–∏—Ç—å</button>
                  <button class="btn-outline btn-sm" onclick="demoteEmployee(${e.id})"><i class="fas fa-arrow-down"></i> –ü–æ–Ω–∏–∑–∏—Ç—å</button>
                  <button class="btn-outline btn-sm" style="border-color:#a00; color:#a00;" onclick="fireEmployee(${e.id})"><i class="fas fa-user-minus"></i> –£–≤–æ–ª–∏—Ç—å</button>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="btn" style="margin-top:20px;" onclick="addEmployee()"><i class="fas fa-user-plus"></i> –ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–æ–≤–æ–≥–æ</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-bullhorn"></i> –û–±—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</div>
          <textarea id="akimMessage" rows="3" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è..."></textarea>
          <button class="btn" onclick="sendAkimNotification()"><i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –∂–∏—Ç–µ–ª—è–º</button>
        </div>
      </div>`;
  }
  window.promoteEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { emp.position = emp.position.includes('–ë—Ä–∏–≥–∞–¥–∏—Ä') ? '–°—Ç–∞—Ä—à–∏–π –±—Ä–∏–≥–∞–¥–∏—Ä' : '–ë—Ä–∏–≥–∞–¥–∏—Ä'; await saveEmployees(emps); switchSection('akimat'); }
  };
  window.demoteEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { emp.position = emp.position.includes('–†–∞–±–æ—á–∏–π') ? '–°—Ç–∞–∂—ë—Ä' : '–†–∞–±–æ—á–∏–π'; await saveEmployees(emps); switchSection('akimat'); }
  };
  window.fireEmployee = async function(id) {
    let emps = await getEmployees();
    let emp = emps.find(e => e.id === id);
    if (emp) { emp.status = 'inactive'; await saveEmployees(emps); switchSection('akimat'); }
  };
  window.addEmployee = async function() {
    let name = prompt("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:");
    if (!name) return;
    let emps = await getEmployees();
    let newId = emps.length ? Math.max(...emps.map(e=>e.id)) + 1 : 1;
    emps.push({ id: newId, name, position: "–°—Ç–∞–∂—ë—Ä", status: "active", rating: 3.0 });
    await saveEmployees(emps);
    switchSection('akimat');
  };
  window.sendAkimNotification = async function() {
    let msg = document.getElementById('akimMessage')?.value.trim();
    if (!msg) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `–ê–∫–∏–º ${currentUser.name}`, to: 'citizen', role: 'citizen', text: msg, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert("–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –∂–∏—Ç–µ–ª—è–º!");
    document.getElementById('akimMessage').value = '';
  };

  async function renderExecutors() {
    return `<div class="section-header"><i class="fas fa-hard-hat"></i><h2>–ü–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-comment-dots"></i> –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞—è–≤–∫—É</div>
          <select id="reviewSelect" class="fake-input" style="width:100%; margin-bottom:16px;">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É --</option>
            ${(await getReviews()).filter(r => r.status === 'active').map(r => `<option value="${r.id}">${r.userName}: ${r.text.substring(0,30)}</option>`).join('')}
          </select>
          <textarea id="executorResponse" rows="2" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..."></textarea>
          <button class="btn" onclick="sendExecutorResponse()"><i class="fas fa-reply"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-user-tie"></i> –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∞–∫–∏–º—É</div>
          <textarea id="executorToAkim" rows="3" style="width:100%; padding:12px; border-radius:16px; border:1px solid #cde0ea; margin-bottom:16px;" placeholder="–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è..."></textarea>
          <button class="btn" onclick="sendToAkim()"><i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–∫–∏–º—É</button>
        </div>
      </div>`;
  }
  window.sendExecutorResponse = async function() {
    const id = document.getElementById('reviewSelect')?.value;
    const text = document.getElementById('executorResponse')?.value.trim();
    if (!id || !text) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É –∏ –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç");
    const review = (await getReviews()).find(r => r.id == id);
    if (!review) return;
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${currentUser.name}`, to: 'user', userIin: review.userId, text: `–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –æ—Ç–∑—ã–≤: ${text}`, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∂–∏—Ç–µ–ª—é!");
  };
  window.sendToAkim = async function() {
    const text = document.getElementById('executorToAkim')?.value.trim();
    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");
    let nots = await getNotifications();
    nots.push({ id: Date.now(), from: `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${currentUser.name}`, to: 'role', role: 'akim', text: `–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: ${text}`, date: new Date().toLocaleDateString(), read: false });
    await saveNotifications(nots);
    alert("–û–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–∫–∏–º—É!");
    document.getElementById('executorToAkim').value = '';
  };

  async function renderCitizens() {
    return `<div class="section-header"><i class="fas fa-user-group"></i><h2>–ü–æ—Ä—Ç–∞–ª –∂–∏—Ç–µ–ª—è</h2></div>
      <div class="grid-2">
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-map-marked-alt"></i> –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</div>
          <button class="btn" onclick="openReviewModal()"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </div>
        <div class="card" style="cursor:default;">
          <div class="card-title"><i class="fas fa-clock"></i> –ú–æ–∏ –∑–∞—è–≤–∫–∏</div>
          ${(await getReviews()).filter(r => r.userId === currentUser.iin).map(r => `
            <div style="border-bottom:1px solid #eee; padding:12px 0;">
              <p><strong>${r.text}</strong> <span class="badge">‚≠ê ${r.rating} | üèÖ ${r.points}</span></p>
              <small>–°—Ç–∞—Ç—É—Å: ${r.status}</small>
            </div>`).join('') || '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫.</p>'}
        </div>
      </div>`;
  }

  // ---------- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ----------
  window.openNotificationsModal = async function() {
    let nots = await getNotifications();
    nots = nots.filter(n => 
      n.to === 'all' || n.to === currentUser.role || (n.to === 'user' && n.userIin === currentUser.iin)
    ).sort((a,b) => b.id - a.id);
    let html = `<div style="display:flex; justify-content:space-between;"><h3 style="color:#004a7c;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><i class="fas fa-times" style="font-size:1.6rem; color:#6c8fa0; cursor:pointer;" onclick="closeModal('notificationsModal')"></i></div>`;
    if (!nots.length) html += '<p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
    else {
      nots.forEach(n => {
        html += `<div style="padding:16px; background:${n.read ? '#f5faff' : '#fffbe6'}; border-radius:16px; margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between;"><strong>${n.from}</strong> <span style="color:#6c8fa0;">${n.date}</span></div>
          <p style="margin-top:8px;">${n.text}</p>
          ${!n.read ? `<button class="btn-outline btn-sm" style="margin-top:8px;" onclick="markNotificationRead(${n.id})">‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</button>` : ''}
        </div>`;
      });
    }
    const modal = document.getElementById('notificationsModal');
    document.getElementById('notificationsContent').innerHTML = html;
    openModal('notificationsModal');
    let updated = false;
    nots.forEach(n => { if (!n.read) { n.read = true; updated = true; } });
    if (updated) await saveNotifications(nots);
    renderAuthBlock();
  };
  window.markNotificationRead = async function(id) {
    let nots = await getNotifications();
    let n = nots.find(n => n.id === id);
    if (n) n.read = true;
    await saveNotifications(nots);
    openNotificationsModal();
    renderAuthBlock();
  };

  // ========== –ó–ê–ü–£–°–ö =========
  window.onload = async function() {
    await initFirebase();
    renderNavigation();
    await renderAuthBlock();
    switchSection('home');
  };
</script>
</body>
</html>